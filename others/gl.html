<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<title>McbeEringi WebGL</title>
		<script type="text/javascript" src="https://wgld.org/j/minMatrix.js">// https://wgld.org/d/webgl/w013.html</script>
		<script type="text/javascript" src="https://www.onicos.com/staff/iz/amuse/javascript/expert/inflate.js">// https://www.onicos.com/staff/iz/amuse/javascript/expert/zip.html</script>
		<script type="text/javascript" src="https://www.onicos.com/staff/iz/amuse/javascript/expert/deflate.js"></script>
		<script src="https://pagecdn.io/lib/ace/1.4.8/ace.js"></script>
		<script type="text/javascript" src="gl_/models.js"></script>
		<script type="text/javascript" src="gl_/url_fx.js"></script>
		<script type="text/javascript" src="gl_/sh_fx.js"></script>
		<link rel="stylesheet" href="../menu.css">
		<link rel="stylesheet" href="../toggle.css">
		<link rel="stylesheet" href="gl_/gl.css">
	</head>
	<body style="overflow-x:hidden;">
		<canvas id="canvas">JavaScriptが無効になっているようです…</canvas><br>
		<div id="stuff">
			<div align="center">
				<form id="model" style="background-color:#444;" onchange="radio();">
					<span style="color:#fff;">model:</span>
					<input type="radio" name="model" value="0" id="r0" checked><label for="r0"> blocks</label>
					<input type="radio" name="model" value="1" id="r1"><label for="r1"> plane</label>
					<input type="radio" name="model" value="2" id="r2"><label for="r2"> coastal</label>
				</form>
				<div class="button" onclick="re();">compile</div>
			</div>
			<pre id="log" style="font-size:11px;color:#f00;"></pre>

			vertex <br>
			<div id="vsh" class="border">attribute highp vec4 POSITION;
attribute vec4 COLOR;
attribute vec2 TEXCOORD_1;
uniform mat4 WORLDVIEWPROJ;
varying vec4 color;
varying vec2 uv1;

void main(){
	color = COLOR;
	uv1 = TEXCOORD_1;
	gl_Position = WORLDVIEWPROJ * POSITION;
}</div><br>
			fragment <br>
			<div id="fsh" class="border">#extension GL_OES_standard_derivatives : enable
precision mediump float;

uniform highp float TIME;
varying vec4 color;
varying vec2 uv1;

void main(){
	vec4 diffuse = color;
	diffuse.rgb *= max(uv1.x,uv1.y);
	gl_FragColor = diffuse;
}</div>
			<div style="display:flex;flex-wrap:wrap;">
				<div id="url" onclick="url_copy(document.getElementById('ifl').checked);" class="button" style="font-size:18px;">copy url</div>
				<span style="margin:auto 0 auto 15px;background-color:rgba(0,0,0,0);">iflame mode:</span>
				<input type="checkbox" class="toggle" id="ifl">
				<label for="ifl"><div></div></label>
			</div>
			<div>
				available stuffs<br>
				<p>
					#extension GL_OES_standard_derivatives : enable<br>
					attribute highp vec4 POSITION;<br>
					attribute highp vec4 COLOR;<br>
					attribute highp vec2 TEXCOORD_1;<br>
					uniform highp float TIME;<br>
					uniform highp vec4 FOG_COLOR;<br>
					uniform highp vec4 CURRENT_COLOR;<br>
					uniform highp mat4 WORLDVIEWPROJ;
				</p><br>
				TODO<br>
				<p>
					toggle of FOG_COLOR, cull & blend<br>
					more models<br>
					model import
				</p>
			</div>
			<input class="menu" type="checkbox" id="menu">
			<label for="menu" style="margin-top:24px;margin-right:5px;">
				<div class="menusub"></div>
				<div class="menul">
					<h3>Config</h3>
					<div>
						<label for="fps">fps</label><br>
						<input type="number" id="fps" value="60" oninput="if(this.value!=0)fps=this.value;" class="border" style="width:4em;">
					</div><br>
					<div>
						<label for="c_c">CURRENT_COLOR</label><br>
						<input type="text" id="c_c" value="1.0, 1.0, 1.0, 1.0" onchange="c_c=this.value.split(',')" class="border">
					</div><br>
					<div>
						<label for="c_rot">cam_rot</label><br>
						<input type="text" id="c_rot" value="0.5, 0.5*TIME, 0.0" onchange="c_rot=this.value" class="border">
					</div><br>
					<div>
						<label for="c_os">cam_offset</label><br>
						<input type="text" id="c_os" value="0.0, 0.0, 5.0" onchange="c_os=this.value" class="border">
					</div><br>

					<a href="https://mcbeeringi.github.io">Home</a>
				</div>
			</label>
			<div align="center">
				powered by WebGL1.0 <br>
				thanks to <a href="https://wgld.org" target="_blank">wgld.org</a> <br>
				display: 1600px * 900px <br>
				<a href="https://twitter.com/mcbeeringi" target="_blank">@McbeEringi</a>.｡:+* <br>　
			</div>
		</div>
		<div style="height:0px;">
			<!-- last-child回避用? -->
		</div>
		<script>
			var vsh = ace.edit("vsh",{
				//readOnly: true,
				showInvisibles: true,
				theme: "ace/theme/monokai",
				mode: "ace/mode/glsl",
				minLines: 16,
				maxLines: 32,
				fontSize: 12,
				wrap: true,
				useSoftTabs: false,
				tabSize: 2
			});
			var fsh = ace.edit("fsh",{
				//readOnly: true,
				showInvisibles: true,
				theme: "ace/theme/monokai",
				mode: "ace/mode/glsl",
				minLines: 16,
				maxLines: 32,
				fontSize: 12,
				wrap: true,
				useSoftTabs: false,
				tabSize: 2
			});
			url_i();
			var glpre = "#define round(x) floor(x+.5)\n";

			// https://qiita.com/laineus/items/12a220d2ab086931232d
			const TAB_STR = '	'
			document.addEventListener('keydown', e => {
				if (e.target.tagName !== 'TEXTAREA' || e.keyCode !== 9) return false
				e.preventDefault()
				const slct = { left: e.target.selectionStart, right: e.target.selectionEnd }
				const lineStart = e.target.value.substr(0, slct.left).split('\n').length - 1
				const lineEnd = e.target.value.substr(0, slct.right).split('\n').length - 1
				const lines = e.target.value.split('\n')
				for (const i in lines) {
					if (i < lineStart || i > lineEnd || lines[i] === '') continue
					if (!e.shiftKey) {
						// 行頭にタブ挿入
						lines[i] = TAB_STR + lines[i]
						slct.left += i == lineStart ? TAB_STR.length : 0
						slct.right += TAB_STR.length
					} else if (lines[i].substr(0, TAB_STR.length) === TAB_STR) {
						// 行頭のタブ削除
						lines[i] = lines[i].substr(TAB_STR.length)
						slct.left -= i == lineStart ? TAB_STR.length : 0
						slct.right -= TAB_STR.length
					}
				}
				e.target.value = lines.join('\n')
				e.target.setSelectionRange(slct.left, slct.right)
				return false
			})

			// https://wgld.org
			var c = document.getElementById("canvas");
			c.width = 1600;
			c.height = 900;
			var gl = c.getContext("webgl") || c.getContext("experimental-webgl");
			gl.enable(gl.CULL_FACE);
			gl.frontFace(gl.CCW);//gl.frontFace(gl.CW);
			gl.enable(gl.DEPTH_TEST);
			gl.depthFunc(gl.LEQUAL);
			gl.enable(gl.BLEND);
			gl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE);
			gl.getExtension("OES_standard_derivatives");

			var prg = create_program(create_shader("vsh"), create_shader("fsh"));//シェダープログラム生成

			var POSITION = gl.getAttribLocation(prg, "POSITION");//attributeLocationの取得
			var COLOR = gl.getAttribLocation(prg, "COLOR");
			var TEXCOORD_1 = gl.getAttribLocation(prg, "TEXCOORD_1");

			var pos, col, index;
			var pos_v = gl.createBuffer();
			var col_v = gl.createBuffer();
			var uv1_v = gl.createBuffer();
			att([pos_v, col_v, uv1_v], [POSITION,COLOR,TEXCOORD_1], [4,4,2]);
			gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.createBuffer());//ibo
			radio();

			//minMatrixb.jsを用いた行列関連処理
			//各種行列の生成と初期化
			var m = new matIV();
			var WORLD = m.identity(m.create());
			var VIEW = m.identity(m.create());
			var PROJ = m.identity(m.create());
			var WORLDVIEWPROJ = m.identity(m.create());

			var FOG_COLOR = [.70,.82,.98,1.];
			var TIME = 0;
			var fps = document.getElementById("fps").value;
			var c_c = document.getElementById("c_c").value.split(",");
			var c_rot = document.getElementById("c_rot").value;
			var c_rot_;
			var c_os = document.getElementById("c_os").value;
			var c_os_;
			(function(){
				TIME+=1/fps;
				clear(FOG_COLOR);

				c_os_ = eval("["+c_os+"]");
				m.lookAt([0,0,c_os_[2]], [c_os_[0],c_os_[1],0], [0,1,0], VIEW);//ビュー座標変換行列
				m.perspective(70, c.width / c.height, 0.1, 100, PROJ);//プロジェクション座標変換行列
				m.multiply(PROJ, VIEW, WORLDVIEWPROJ);//各行列を掛け合わせ座標変換行列を完成させる
				m.identity(WORLD);
				c_rot_ = eval("["+c_rot+"]");
				m.rotate(WORLD, c_rot_[0], [1, 0, 0], WORLD);
				m.rotate(WORLD, c_rot_[1], [0, 1, 0], WORLD);
				m.rotate(WORLD, c_rot_[2], [0, 0, 1], WORLD);
				m.multiply(WORLDVIEWPROJ, WORLD, WORLDVIEWPROJ);

				var uniform = [//uniformLocationの取得
					gl.getUniformLocation(prg, "WORLDVIEWPROJ"),
					gl.getUniformLocation(prg, "TIME"),
					gl.getUniformLocation(prg, "FOG_COLOR"),
					gl.getUniformLocation(prg, "CURRENT_COLOR")
				];
				gl.uniformMatrix4fv(uniform[0], false, WORLDVIEWPROJ);//uniformLocationへ座標変換行列を登録
				gl.uniform1f(uniform[1], TIME);
				gl.uniform4fv(uniform[2], FOG_COLOR);
				gl.uniform4fv(uniform[3], c_c);
				gl.drawElements(gl.TRIANGLES, index.length, gl.UNSIGNED_SHORT, 0);//モデルの描画
				gl.flush();//コンテキストの再描画
				setTimeout(arguments.callee, 1000/fps);
			})();
		</script>
	</body>
</html>
