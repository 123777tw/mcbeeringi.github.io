<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0">

		<!--iOS-->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="default">
		<meta name="apple-mobile-web-app-title" content="GLSL">
		<link rel="apple-touch-icon" href="img/gl.png">
		<!--Android-->
		<link rel="manifest" href="manifest.json">
		<script>
			if ('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').then((reg) => {console.log('Service worker registered.', reg);});}
		</script>

		<title>McbeEringi WebGL</title>
		<script src="https://wgld.org/j/minMatrix.js" type="text/javascript">// https://wgld.org/d/webgl/w013.html</script>
		<script type="text/javascript" src="https://www.onicos.com/staff/iz/amuse/javascript/expert/inflate.js">// https://www.onicos.com/staff/iz/amuse/javascript/expert/zip.html</script>
		<script type="text/javascript" src="https://www.onicos.com/staff/iz/amuse/javascript/expert/deflate.js"></script>
		<style>
			body{user-select:none;-webkit-user-select:none;}
			body,body *{background-color:rgba(32,32,32,1.0);color:#fff;margin:0;font-family:menlo,sans-serif;word-wrap:break-word;}
			button{margin:7px;font-size:24px;width:45vw;min-width:128px;border:0px solid;border-radius:5px;box-shadow:0 0 7px;}
			button:hover{background-color:rgba(0,88,208,.5);}
			button:active{background-color:rgb(0,88,208);color:#eee;box-shadow:0 0 7px 0 #aaa inset;}
			canvas,textarea{width:100%;}textarea{resize:vertical;}
			p{font-size:11px;margin-left:7px;background-color:rgba(0,0,0,0);user-select:text;-webkit-user-select:text;}
			form *{background-color:rgba(0,0,0,0);}
			input{max-width:100%;}
			input[type=radio]{display:none;}
			input[type="radio"]+label{color:#888;}
			input[type="radio"]:hover+label{color:#aaa;}
			input[type="radio"]:checked+label{color:#fff;}
			.border{border:1px solid #888;border-radius:5px;}

			.toggle{margin:auto 1px;width:50px;height:29px;border-radius:14.5px;background-color:#444;box-shadow:0 0 4px 0 #0008 inset;transition:.5s;}
			.toggle *{margin:0 auto;position:relative;top:1px;width:27px;height:27px;background-color:#fff;border-radius:50%;box-shadow:0 0 4px 0 #0004;left:-10.5px;transition:.2s;}
			.toggle.on{background-color:#4f4;}.toggle.on *{left:10.5px;}

			.pd{font-size:13px;background-color:rgba(255,255,255,.25);text-align:center;border-radius:0px 0px 5px 5px;}
		</style>
	</head>
	<body style="overflow-x:hidden;">
		<canvas id="canvas">JavaScriptが無効になっているようです…</canvas><br>
		<div id="stuff">
			<div align="center">
				<form id="model" style="background-color:#444;" onchange="radio();">
					<span style="color:#fff;">model:</span>
					<input type="radio" name="model" value="0" id="r0" checked><label for="r0"> blocks</label>
					<input type="radio" name="model" value="1" id="r1"><label for="r1"> plane</label>
					<input type="radio" name="model" value="2" id="r2"><label for="r2"> coastal</label>
				</form>
				<label>fps:<input type="number" id="fps" value="60" oninput="if(this.value!=0)fps=this.value;" class="border" style="width:4em;"></label>
				<label>CURRENT_COLOR:<input type="text" id="c_c" value="1.0, 1.0, 1.0, 1.0" onchange="c_c=this.value.split(',')" class="border"></label><br>
				<label>cam_rot:<input type="text" id="c_rot" value="0.5, 0.5*TIME, 0.0" onchange="c_rot=this.value" class="border"></label><br>
				<label>cam_offset:<input type="text" id="c_os" value="0.0, 0.0, 5.0" onchange="c_os=this.value" class="border"></label><br>
				<button onclick="re();">compile</button>
			</div>
			<pre id="log" style="font-size:11px;color:#f00;"></pre>

			vertex <br>
			<textarea rows="16" id="vsh" class="border" style="border-radius:5px 5px 0px 0px;">
attribute highp vec4 POSITION;
attribute vec4 COLOR;
uniform mat4 WORLDVIEWPROJ;
varying vec4 color;
varying highp vec3 cPos;

void main(){
	color = COLOR;
	cPos = POSITION.xyz;
	gl_Position = WORLDVIEWPROJ * POSITION;
}</textarea><div class="pd border">▲▼工事中</div>
			fragment <br>
			<textarea rows="16" id="fsh" class="border" style="border-radius:5px 5px 0px 0px;">
#extension GL_OES_standard_derivatives : enable
precision mediump float;

uniform highp float TIME;
varying vec4 color;
varying highp vec3 cPos;

void main(){
	vec3 n = normalize(cross(dFdx(cPos),dFdy(cPos)));
	gl_FragColor = color;//vec4(n*.5+.5,1);
}</textarea><div class="pd border">▲▼工事中</div>
			<div style="display:flex;flex-wrap:wrap;">
				<button id="url" onclick="clipboard();" class="border" style="font-size:18px;">copy url</button>
				<span style="margin:auto 0 auto 15px;background-color:rgba(0,0,0,0);">iflame mode:</span>
				<div id="ifl" class="toggle" onclick="ifl=ifl?false:true;if(ifl)this.className='toggle on';else this.className='toggle';"><div></div></div>
			</div>
			<div style="height:80vh">
				available stuffs<br>
				<p>
					#extension GL_OES_standard_derivatives : enable<br>
					attribute highp vec4 POSITION;<br>
					attribute highp vec4 COLOR;<br>
					uniform highp float TIME;<br>
					uniform highp vec4 FOG_COLOR;<br>
					uniform highp vec4 CURRENT_COLOR;<br>
					uniform highp mat4 WORLDVIEWPROJ;
				</p><br>
				TODO<br>
				<p>
					toggle of FOG_COLOR, cull & blend<br>
					more models<br>
					model import
				</p>
			</div><!--キーボード用空白-->
			<div align="center">
				powered by WebGL1.0 <br>
				thanks to <a href="https://wgld.org" target="_blank">wgld.org</a> <br>
				display: 1600px * 900px <br>
				<a href="https://twitter.com/mcbeeringi" target="_blank">@McbeEringi</a>.｡:+* <br>　
			</div>
		</div>

		<script>
			var ifl = false;
			url_i();
			var glpre = "#define round(x) floor(x+.5)\n";

			// https://qiita.com/laineus/items/12a220d2ab086931232d
			const TAB_STR = '	'
			document.addEventListener('keydown', e => {
				if (e.target.tagName !== 'TEXTAREA' || e.keyCode !== 9) return false
				e.preventDefault()
				const slct = { left: e.target.selectionStart, right: e.target.selectionEnd }
				const lineStart = e.target.value.substr(0, slct.left).split('\n').length - 1
				const lineEnd = e.target.value.substr(0, slct.right).split('\n').length - 1
				const lines = e.target.value.split('\n')
				for (const i in lines) {
					if (i < lineStart || i > lineEnd || lines[i] === '') continue
					if (!e.shiftKey) {
						// 行頭にタブ挿入
						lines[i] = TAB_STR + lines[i]
						slct.left += i == lineStart ? TAB_STR.length : 0
						slct.right += TAB_STR.length
					} else if (lines[i].substr(0, TAB_STR.length) === TAB_STR) {
						// 行頭のタブ削除
						lines[i] = lines[i].substr(TAB_STR.length)
						slct.left -= i == lineStart ? TAB_STR.length : 0
						slct.right -= TAB_STR.length
					}
				}
				e.target.value = lines.join('\n')
				e.target.setSelectionRange(slct.left, slct.right)
				return false
			})

			// https://wgld.org
			var c = document.getElementById("canvas");
			c.width = 1600;
			c.height = 900;
			var gl = c.getContext("webgl") || c.getContext("experimental-webgl");
			gl.enable(gl.CULL_FACE);
			gl.frontFace(gl.CCW);//gl.frontFace(gl.CW);
			gl.enable(gl.DEPTH_TEST);
			gl.depthFunc(gl.LEQUAL);
			gl.enable(gl.BLEND);
			gl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE);
			gl.getExtension("OES_standard_derivatives");

			var prg = create_program(create_shader("vsh"), create_shader("fsh"));//シェダープログラム生成

			var POSITION = gl.getAttribLocation(prg, "POSITION");//attributeLocationの取得
			var COLOR = gl.getAttribLocation(prg, "COLOR");

			var pos, col, index;
			var pos_v = gl.createBuffer();
			var col_v = gl.createBuffer();
			att([pos_v, col_v], [POSITION,COLOR], [4,4]);
			gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.createBuffer());//ibo
			radio();

			//minMatrixb.jsを用いた行列関連処理
			//各種行列の生成と初期化
			var m = new matIV();
			var WORLD = m.identity(m.create());
			var VIEW = m.identity(m.create());
			var PROJ = m.identity(m.create());
			var WORLDVIEWPROJ = m.identity(m.create());

			var FOG_COLOR = [.70,.82,.98,1.];
			var TIME = 0;
			var fps = document.getElementById("fps").value;
			var c_c = document.getElementById("c_c").value.split(",");
			var c_rot = document.getElementById("c_rot").value;
			var c_rot_;
			var c_os = document.getElementById("c_os").value;
			var c_os_;
			(function(){
				TIME+=1/fps;
				clear(FOG_COLOR);

				c_os_ = eval("["+c_os+"]");
				m.lookAt([0,0,c_os_[2]], [c_os_[0],c_os_[1],0], [0,1,0], VIEW);//ビュー座標変換行列
				m.perspective(70, c.width / c.height, 0.1, 100, PROJ);//プロジェクション座標変換行列
				m.multiply(PROJ, VIEW, WORLDVIEWPROJ);//各行列を掛け合わせ座標変換行列を完成させる
				m.identity(WORLD);
				c_rot_ = eval("["+c_rot+"]");
				m.rotate(WORLD, c_rot_[0], [1, 0, 0], WORLD);
				m.rotate(WORLD, c_rot_[1], [0, 1, 0], WORLD);
				m.rotate(WORLD, c_rot_[2], [0, 0, 1], WORLD);
				m.multiply(WORLDVIEWPROJ, WORLD, WORLDVIEWPROJ);

				var uniform = [//uniformLocationの取得
					gl.getUniformLocation(prg, "WORLDVIEWPROJ"),
					gl.getUniformLocation(prg, "TIME"),
					gl.getUniformLocation(prg, "FOG_COLOR"),
					gl.getUniformLocation(prg, "CURRENT_COLOR")
				];
				gl.uniformMatrix4fv(uniform[0], false, WORLDVIEWPROJ);//uniformLocationへ座標変換行列を登録
				gl.uniform1f(uniform[1], TIME);
				gl.uniform4fv(uniform[2], FOG_COLOR);
				gl.uniform4fv(uniform[3], c_c);
				gl.drawElements(gl.TRIANGLES, index.length, gl.UNSIGNED_SHORT, 0);//モデルの描画
				gl.flush();//コンテキストの再描画
				setTimeout(arguments.callee, 1000/fps);
			})();


			function re(){
				document.getElementById("log").innerHTML = "";
				prg = create_program(create_shader("vsh"), create_shader("fsh"));
			}
			function url_i(){
				// https://qiita.com/tonkatu_tanaka/items/99d167ded9330dbc4019
				var pair=location.search.substring(1);
				if(pair){
					pair = pair.split("&");
					var arg = new Object;
					for(var i=0;pair[i];i++) {
						var kv = pair[i].split("=");
						arg[kv[0]]=kv[1];
					}
					console.log(arg);
					if(arg.vsh)document.getElementById("vsh").innerHTML=unescape(zip_inflate(atob(arg.vsh.replace(/-/g,"+").replace(/_/g,"/"))));
					if(arg.fsh)document.getElementById("fsh").innerHTML=unescape(zip_inflate(atob(arg.fsh.replace(/-/g,"+").replace(/_/g,"/"))));
					if(arg.fps)document.getElementById("fps").value=arg.fps;
					if(arg.c_c)document.getElementById("c_c").value=arg.c_c.replace(/,/g,", ");
					if(arg.c_rot)document.getElementById("c_rot").value=arg.c_rot.replace(/,/g,", ");
					if(arg.c_os)document.getElementById("c_os").value=arg.c_os.replace(/,/g,", ");
					if(arg.model){var model = document.getElementById("model").model;model[0].checked=false;model[arg.model].checked=true;}
					if(arg.stuff)document.getElementById("stuff").style.display=arg.stuff;
				}
			}
			function url_e(){
				var e_fps = document.getElementById("fps").value;
				if(ifl && e_fps>30)e_fps = 30;
				var e_c_c = document.getElementById("c_c").value.replace(/\s+/g,"");
				var e_c_rot = document.getElementById("c_rot").value.replace(/\s+/g,"");
				var e_c_os = document.getElementById("c_os").value.replace(/\s+/g,"");
				var e_model = document.getElementById("model").model.value;
				var url = location.href.replace(/\?.*$/,"")
					+"?vsh="+btoa(zip_deflate(escape(document.getElementById("vsh").value))).replace(/\+/g,"-").replace(/\//g,"_")
					+"&fsh="+btoa(zip_deflate(escape(document.getElementById("fsh").value))).replace(/\+/g,"-").replace(/\//g,"_");
				if(e_fps!=60)url += "&fps="+e_fps;
				if(e_c_c!="1.0,1.0,1.0,1.0")url += "&c_c="+e_c_c;
				if(e_c_rot!="0.5,0.5*TIME,0.0")url += "&c_rot="+e_c_rot;
				if(e_c_os!="0.0,0.0,5.0")url += "&c_os="+e_c_os;
				if(e_model!=0)url += "&model="+e_model;
				if(ifl)url = "<iframe style='width:1600;height:900' class='gl' src='"+url+"&stuff=none'>";//iflame用
				return url;
			}
			function clipboard(){
				var disp = document.getElementById("url");
				if (execCopy(url_e()))disp.innerHTML = "copied!";
				setTimeout(function(){disp.innerHTML = "copy url";}, 1000);
			}
			//https://qiita.com/simiraaaa/items/2e7478d72f365aa48356
			function execCopy(string) {
				var tmp = document.createElement("div");//空div 生成
				var pre = document.createElement("pre");//選択用のタグ生成
				pre.style.webkitUserSelect = "auto";//親要素のCSSでuser-select:noneだとコピーできないので書き換える
				pre.style.userSelect = "auto";
				tmp.appendChild(pre).textContent = string;
				var s = tmp.style;//要素を画面外へ
				s.position = "fixed";
				s.right = "200%";
				document.body.appendChild(tmp);//bodyに追加
				document.getSelection().selectAllChildren(tmp);//要素を選択
				var result = document.execCommand("copy");//クリップボードにコピー
				document.body.removeChild(tmp);//要素削除
				return result;
			}


			function radio(){
				var value = document.getElementById("model").model.value;
				if(value==0){
					pos = [
						-1.,1.,-1.,1., 0.,1.,-1.,1.,  -1.,1.,0.,1., 0.,1.,0.,1.,
						-1.,0.,-1.,1., 0.,0.,-1.,1., 1.,0.,-1.,1.,  -1.,0.,0.,1., 0.,0.,0.,1., 1.,0.,0.,1.,  -1.,0.,1.,1., 0.,0.,1.,1.,
						-1.,-1.,-1.,1., 0.,-1.,-1.,1., 1.,-1.,-1.,1.,  -1.,-1.,0.,1., 0.,-1.,0.,1., 1.,-1.,0.,1.,  -1.,-1.,1.,1., 0.,-1.,1.,1.
					];
					col = [
						.6,.6,.6,1., .8,.8,.8,1.,  .8,.8,.8,1., 1.,1.,1.,1.,
						.4,.4,.4,1., .6,.6,.6,1., .8,.8,.8,1.,  .6,.6,.6,1., .8,.8,.8,1.,1.,1.,1.,1.,  .8,.8,.8,1., 1.,1.,1.,1.,
						.2,.2,.2,1., .4,.4,.4,1., .6,.6,.6,1.,  .4,.4,.4,1., .6,.6,.6,1., .8,.8,.8,1.,  .6,.6,.6,1., .8,.8,.8,1.
					];
					index = [
						2,1,0, 1,2,3,  7,3,2, 3,7,8, 8,1,3, 1,8,5, 5,0,1, 0,5,4, 4,2,0, 2,4,7,
						10,8,7, 8,10,11, 8,6,5, 6,8,9,  18,11,10, 11,18,19, 19,8,11, 8,19,16, 16,9,8, 9,16,17, 17,6,9, 6,17,14, 14,5,6, 5,14,13, 13,4,5, 4,13,12, 12,7,4, 7,12,15, 15,10,7, 10,15,18,
						13,15,12, 15,13,16, 14,16,13, 16,14,17, 16,18,15, 18,16,19
					];
				}
				else if(value==1){
					pos = [
						-2.,0.,-2.,1.,  -1.,0.,-2.,1.,  0.,0.,-2.,1.,  1.,0.,-2.,1.,  2.,0.,-2.,1.,
						-2.,0.,-1.,1.,  -1.,0.,-1.,1.,  0.,0.,-1.,1.,  1.,0.,-1.,1.,  2.,0.,-1.,1.,
						-2.,0., 0.,1.,  -1.,0., 0.,1.,  0.,0., 0.,1.,  1.,0., 0.,1.,  2.,0., 0.,1.,
						-2.,0., 1.,1.,  -1.,0., 1.,1.,  0.,0., 1.,1.,  1.,0., 1.,1.,  2.,0., 1.,1.,
						-2.,0., 2.,1.,  -1.,0., 2.,1.,  0.,0., 2.,1.,  1.,0., 2.,1.,  2.,0., 2.,1.
					];
					col = [
						1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1.,
						1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1.,
						1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1.,
						1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1.,
						1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1.
					];
					index = [
						 6, 0, 5, 0, 6, 1,  7, 1, 6, 1, 7, 2,  8, 2, 7, 2, 8, 3,  9, 3, 8, 3, 9, 4,
						11, 5,10, 5,11, 6, 12, 6,11, 6,12, 7, 13, 7,12, 7,13, 8, 14, 8,13, 8,14, 9,
						16,10,15,10,16,11, 17,11,16,11,17,12, 18,12,17,12,18,13, 19,13,18,13,19,14,
						21,15,20,15,21,16, 22,16,21,16,22,17, 23,17,22,17,23,18, 24,18,23,18,24,19
					];
				}
				else if(value==2){
					pos = [
						0.,0.,0.,1., 1.,0.,0.,1., 0.,1.,0.,1., 0.,0.,1.,1.
					];
					col = [
						0.,0.,0.,1., 1.,1.,1.,1., 1.,1.,1.,1., 1.,1.,1.,1.
					];
					index = [
						0,2,1, 0,3,2, 0,1,3, 1,2,3
					];
				}
				gl.bindBuffer(gl.ARRAY_BUFFER, pos_v);
				gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(pos), gl.STATIC_DRAW);
				gl.bindBuffer(gl.ARRAY_BUFFER, col_v);
				gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(col), gl.STATIC_DRAW);
				gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Int16Array(index), gl.STATIC_DRAW);
			}
			function clear(c){
				gl.clearColor(c[0],c[1],c[2],c[3]);
				gl.clearDepth(1.);
				gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
			}
			function create_shader(id){
				if(id=="vsh")var shader = gl.createShader(gl.VERTEX_SHADER);
				else if(id=="fsh")var shader = gl.createShader(gl.FRAGMENT_SHADER);
				gl.shaderSource(shader, glpre+document.getElementById(id).value);
				gl.compileShader(shader);
				if(gl.getShaderParameter(shader, gl.COMPILE_STATUS))return shader;
				else document.getElementById("log").innerHTML += id+" ERROR\n"+gl.getShaderInfoLog(shader);
			}
			function create_program(vsh, fsh){
				var program = gl.createProgram();
				gl.attachShader(program, vsh);
				gl.attachShader(program, fsh);
				gl.linkProgram(program);
				document.getElementById("log").innerHTML += gl.getProgramInfoLog(program);
				if(gl.getProgramParameter(program, gl.LINK_STATUS)){
					gl.useProgram(program);
					return program;
				}
			}
			function att(vbo, attL, attS){
				for(var i in vbo){//引数として受け取った配列を処理する
					gl.bindBuffer(gl.ARRAY_BUFFER, vbo[i]);//バッファをバインドする
					gl.enableVertexAttribArray(attL[i]);//attributeLocationを有効にする
					gl.vertexAttribPointer(attL[i], attS[i], gl.FLOAT, false, 0, 0);//attributeLocationを通知し登録する
					gl.bindBuffer(gl.ARRAY_BUFFER, null);//バッファのバインドを無効化
				}
			}
		</script>
	</body>
</html>
