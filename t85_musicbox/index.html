<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<script async src="https://mcbeeringi.github.io/src/gas.js"></script>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi t85_musicbox mml</title>
	<meta name="description" content="mml for SAZANKA Robotics music box">
	<link rel="icon" type="image/svg+xml" href="../img/icon.svg">
	<link rel="apple-touch-icon" href="../img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="../src/style.css">
</head>
<body>
	<style>
		.input{font-family:monospace;width:100%;white-space:pre;}
		pre{white-space:pre-wrap;word-break:break-all;}
	</style>
	<textarea class="input" id="cfg" spellcheck="false">{
	bpm:131,// テンポ
	minNote:1/16,// 音符の最小単位
	wvd:[// 音色(2bit) 音量(2bit) 減衰(1bit)
		0b01110,
		0b01111,
		0b01111,
		0b01110
	]
}</textarea>
	<textarea class="input" id="inp" spellcheck="false">&gt;1ar4a1brarFr2ar
1ar4a1brarFr2ar
1drdrdrer5F1rdr
5F1rar8a
1drdrdrer8F
1drdrdrer8F
1erererdr2erFrargrFrer,

&lt;2r
1a3r1a3r1aa2r1a3r1a3r1a3r1aa2r1a3r
1b3r1b3r1bb2r1b3r1b3r1b3r1bb2r1b3r
1b3r1b3r1bb2r1b3r1b3r1b3r1bb2r1b3r
1a3r1a3r1aa2r1a3r1a3r1a3r1aa2ra,

&lt;2r
1F3r1F3r1FF2r1F3r1F3r1F3r1FF2r1F3r
1F3r1F3r1FF2r1F3r1F3r1F3r1FF2r1F3r
1g3r1g3r1gg2r1g3r1g3r1g3r1gg2r1g3r
1e3r1e3r1ee2r1e3r1e3r1e3r1ee2re,

&lt;4d&lt;a&gt;d&lt;a&gt;d&lt;a&gt;3d&lt;1a&gt;2dC&lt;
4bFbFbF3b1F2ba
4gdg&gt;d&lt;gd2gdgb
4aeaeae&gt;2C&lt;b4a</textarea>
	<button class="button" id="btn">run</button>
	<pre id="log"></pre>
	<a id="anc">qr</a>
	
	<script type="module">
		import TA from'https://mcbeeringi.github.io/ta/ta+.mjs';
		let stop;
		const
			actx=new(window.AudioContext||webkitAudioContext)(),
			master=actx.createGain(),
			fft=(w,l=12)=>{
				w=w.flatMap(x=>new Array(2**l/w.length).fill().map(()=>[x,0]));
				const add=([[a,b],[c,d]])=>[a+c,b+d],sub=([[a,b],[c,d]])=>[a-c,b-d],mul=([a,b],[c,d])=>[a*c-b*d,a*d+b*c],cm=t=>[Math.cos(t),Math.sin(t)],trs=x=>x[0].map((_,i)=>x.map(y=>y[i])),
					core=(n=w.length,t=-Math.PI/n,p=0,o=1,x,y)=>n==1?[w[p]]:(y=core(n/=2,t*=2,p+o,o*=2),x=core(n,t,p,o).map((z,i)=>[z,mul(y[i],cm(t*i))]),x.map(add).concat(x.map(sub)));
				return trs(core()).map(x=>new Float32Array([0,...x.slice(1)]));
			},
			pwav=[[1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],[1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],].map(x=>actx.createPeriodicWave(...fft(x.map(y=>y*2-1)))),
			play=({w=inp.value,bpm=120,minNote=1/16,wvd=new Array(4).fill(0b00111)})=>(
				minNote=1/minNote,
				w=w.split(',').map((p,i)=>(
					p=p
					.match(/[cdefgabr><]|\d+/ig)
					.reduce((a,x)=>{
						if(isNaN(x))
							({'>':_=>a.o++,'<':_=>a.o--}[x]||(_=>{
								const n=Object.fromEntries([...'c d ef g a b'].map(Array))[x.toLowerCase()]+(x==x.toUpperCase());
								if(!isNaN(n)){
									const osc=actx.createOscillator(),g0=actx.createGain(),g1=actx.createGain(),ct=actx.currentTime+a.a*a.dt,d=a.x*a.dt;
									osc.setPeriodicWave(pwav[wvd[i]>>3]);
									osc.frequency.value=440*(2**((n-57)/12+a.o));
									(wvd[i]&1)&&g0.gain.setTargetAtTime(0,ct,.3);
									g1.gain.value=[0x40,0x80,0xc0,0xff][((wvd[i]>>1)&3)]/0xff;
									[osc,g0,g1,master].reduce((a,x)=>(a.connect(x),x));
									osc.start(ct);osc.stop(ct+d);
									a.s.push(_=>osc.stop())
								}
								a.a+=a.x;
								a.h.push((wvd[i]<<11)|((a.o&0x7)<<8)|((isNaN(n)?12:n)<<4)|((a.x-1)&0xf))
							}))();
						else a.x=+x;
						return a;
					},{a:0,x:4,o:4,h:[0],s:[],dt:240/bpm/minNote}),
					{h:'\t'+p.h.join(','),s:_=>p.s.forEach(x=>x())}
				)),
				{
					h:`static const uint16_t PROGMEM sheet[]={\n\t((uint16_t)${bpm}<<8)|${minNote},// (BPM<<8)|minNote\n${w.map(x=>x.h).join(',\n')},\n\t0,0\n};`,
					stop:_=>w.forEach(x=>x.s())
				}
			);

		btn.onclick=_=>(stop&&stop(),console.log({stop,h:log.textContent}=play(Function(`return(${cfg.value});`)())),anc.href='https://mcbeeringi.github.io/apps/qr.html#'+encodeURIComponent(log.textContent));
		TA.editor(cfg);TA.editor(inp);
		master.gain.value=.2;master.connect(actx.destination);
	</script>
</body>
</html>