<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>sky_seq indev</title>
		<link rel="preload" href="https://cdn.jsdelivr.net/npm/tone/build/Tone.js" as="script">
	</head>
	<body>
		<script src="https://mcbeeringi.github.io/sky/style.js" async></script>
		<style>
			:root{user-select:none;-webkit-user-select:none;}[contenteditable],.usa{user-select:auto;-webkit-user-select:auto;}
			html,body{height:100%;margin:0;position:relative;}textarea{width:100%;height:50vh;resize:none;box-sizing:border-box;}
			.disp{position:relative;}.disp>*{vertical-align:bottom;}
			#c{image-rendering:crisp-edges;width:100%;height:240px;background:#000a repeating-linear-gradient(#fffc,#fffc 16px,#fff8 16px,#fff8 48px,#fffa 48px,#fffa 64px,#fff8 64px,#fff8 80px,#fffa 80px,#fffa 96px,#fff8 96px,#fff8 112px);}
			#scr{width:100%;height:100%;position:absolute;top:0;overflow-x:scroll;scrollbar-width:thin;scrollbar-color:#0008 #0000;}#scr::webkit-scrollbar{background-color:#0000;height:8px;}#scr::webkit-scrollbar-thumb{background-color:#0008;border-radius:8px;}
			#scrw{height:100%;}
			#dispCur{position:absolute;height:100%;width:16px;background-color:#aef8;left:16px;transition:.1s;}
		</style>
		<div class="disp">
			<canvas id="c"></canvas>
			<div id="scr"><div id="scrw"><div id="dispCur"></div></div></div>
		</div>
		<button id="playbtn">play/pause</button><button id="stopbtn">stop</button>
		<textarea id="dat"></textarea>
		<script src="https://cdn.jsdelivr.net/npm/tone/build/Tone.js"></script>
		<!--<script src="https://mcbeeringi.github.io/src/requestIdleCallback.min.js"></script>-->
		<script>
			'use strict';
			let calced={};
			const i2n=['-9','-7','-5','-4','-2','0','2','3','5','7','8','10','12','14','15'],
			n2i={'-9':'0','-8':'0.5','-7':'1','-6':'1.5','-5':'2','-4':'3','-3':'3.5','-2':'4','-1':'4.5','0':'5','1':'5.5','2':'6','3':'7','4':'7.5','5':'8','6':'8.5','7':'9','8':'10','9':'10.5','10':'11','11':'11.5','12':'12','13':'12.5','14':'13','15':'14'},
			pos2p=pos_=>{let tmp=pos_.split(':').map(x=>Number(x));return tmp[0]*Tone.Transport.timeSignature+tmp[1]+tmp[2]*.25;},
			p2pos=p_=>`${Math.floor(p_/Tone.Transport.timeSignature)}:${Math.floor(p_)%Tone.Transport.timeSignature}:${(p_*4)%4}`,
			n2Hz=x=>440*Math.pow(2,Number(x-2)/12)*2,//C4~C6
			stdli=(a,b=a+1,s={})=>{for(let i=a;i<=b;i++){s[`d#${i}`]=`ds${i}.mp3`;s[`a${i}`]=`a${i}.mp3`;}return s;},
			synth=new Tone.Sampler(stdli(4,6,{'a3':'a3.mp3','d#7':'ds7.mp3'}),()=>{},'https://mcbeeringi.github.io/sky/audio/instr/musicbox/').toDestination(),
			seq=new Tone.Sequence((time,note)=>{
				note=note.split(',');
				let p=pos2p(Tone.Transport.position)%seq.events.length,
				pind=calced.dat.findIndex(x=>Math.abs(x.p-p)<1&&p<x.p)-1;
				if(-1<pind){
					console.log(p);
					dispCur.style.display='';
					dispCur.style.left=`${calced.dat[pind].pos}px`;
				}else dispCur.style.display='none';
				if(note[0]){
					synth.triggerAttackRelease(note.map(n2Hz),'1m',time,1);
				}
			},[],'4n').start(0),
			ctx=c.getContext('2d'),res=window.devicePixelRatio||1,
			frr=(ct,col,x,y,dx,dy,rl=0,rr=rl)=>{
				ct.fillStyle=col;
				ct.beginPath();
				ct.moveTo(x,y+rl);ct.arc(x+rl,y+rl,rl,Math.PI,Math.PI*1.5);
				ct.lineTo(x+dx-rr,y);ct.arc(x+dx-rr,y+rr,rr,Math.PI*1.5,0);
				ct.lineTo(x+dx,y+dy-rr);ct.arc(x+dx-rr,y+dy-rr,rr,0,Math.PI*.5);
				ct.lineTo(x+rl,y+dy);ct.arc(x+rl,y+dy-rl,rl,Math.PI*.5,Math.PI);
				ct.fill();
			},
			a2c=(x,b)=>{
				let pos=-scr.scrollLeft,note=[];
				const w=c.parentNode.clientWidth,
				calc=calced.scr==undefined||Math.abs(calced.scr-scr.scrollLeft)>128||b,
				core=(y,p=0,l=1,ind=[])=>{
					let odl=1/l;
					for(let[yi,z]of y.entries()){
						if(typeof z=='object'){
							let tmp=pos;pos+=13;
							core(z,p,l*z.length,[...ind,yi]);pos+=12;
							if(0<pos&&tmp<w)frr(ctx,'#0004',tmp,0,pos-tmp,240,4);
							pos+=1;
						}else{
							if(-15<pos&&pos<w){
								frr(ctx,'#0004',pos,0,16,240,4,4);
								if(z)z.split(',').forEach(n=>{
									let tmp=false;
									if(n2i[n]==undefined){
										if(Number(n)>0)n=String((Number(n)+9)%24-9);
										else n=String((Number(n)+10)%24+14);
										tmp=true;
									}
									note.push([tmp,pos+1,225-Number(n2i[n])*16]);//240-16+1
								});
							}
							if(-128<pos&&pos<w+128){
								if(calc)calced.dat.push({ind:[...ind,yi],p:p,pos:pos+scr.scrollLeft});
								ctx.fillText(p.toFixed(2),pos,16,16);ctx.fillText([...ind,yi],pos,32,16);
							}
							pos+=17;
						}
						if(pos>w+128&&!b)break;
						p+=odl;
					}
				};
				ctx.clearRect(0,0,w,240);
				pos+=16;
				if(calc){calced.scr=scr.scrollLeft;calced.dat=[];}
				if(x&&Array.isArray(x)){
					core(x);pos+=w*.5;
					note.forEach(y=>frr(ctx,y[0]?'#fea8':'#fea',y[1],y[2],14,14,4));
					if(calc)console.log(calced);
					return pos+scr.scrollLeft;
				}
			};

			scr.onclick=e=>{
				let cp=e.clientX+window.scrollX+scr.scrollLeft,
				np=calced.dat.find(x=>x.pos<=cp&&cp<Number(x.pos)+16);
				console.log({cursor:cp,fixed:np});
				if(np==undefined)return;
				dispCur.style.display='';
				dispCur.style.left=`${np.pos}px`;
				Tone.Transport.position=p2pos(np.p);
			};
			playbtn.onclick=e=>{
				Tone.start();
				Tone.Transport[Tone.Transport.state!='started'?'start':'pause']();
			};
			stopbtn.onclick=e=>{
				Tone.Transport.stop();
			};
			document.onkeydown=e=>{
				if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName))return;
				switch(e.code){
					case'Space':e.preventDefault();playbtn.onclick();break;
				}
			};

			dat.value=`["-4","",["-4","-4"],["-4","-4"],["-9,-4,3","","-4,-2","-2"],["-7,-2,5","","3,-2","5"],["-5,0,7","","0,10","10"],["-5,-2,12","","-2,7","5"],["-9,-4,3","3","-4,7","7"],["-7,-2,5","3","-2,3","5"],["-5,0,7","","0,10",""],["-5,-2,7","","-2",""],["-9,-4,3","","-4,-2",""],["-7,-2,5","","-2,3","5"],["0,-5,7","","0,10",""],["-5,-2,7","","-2,5",""],["-9,-4,3","","-4,7",""],["-7,-2,5","","-2,7",""],["-9,-5,3","","-5,-2",""],["-9,-5","","7","10"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-5,0,3,7","","0",""],["-5,-2,3,7","","3,-2,5","3"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-9,-5,3","","-5,-2",""],["-9,-5,3","","3,5","3,10,7"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-5,0,3,7","","0",""],["-5,-2,3,7","","3,-2,5","3"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,14,10",""],["-5,-2,15,10,3","","-2,3,7","5"],["-9,-4,0","","7,3,-4",""],["-7,-2,2,5,10","","-2,7,3","5"],["-9,-5,3","","-5,-2",""],["-9,-5,0","","-2",""],["-9,-4","7,3"],["","-4","7,3",""],["5,-7,-2,2","","3","-2"],["2","","5,2,-2",""],["3,-5,0","","","0"],["","-2"],["-2,-5","-4"],["-5","-5"],["-9,-4","7,3"],["7,3","-4","7,3",""],["5,-7,-2,2","3"],["2","-2,-7"],["-2,-5,0","7,3"],["5","3,-5,0"],["7,2,-2,5,-5",""],["5,-2,2,-5","3"],["-9,-4","-2"],["7,-9,-4,3","10,7,3"],["-7,-2","7,3"],["2,-2,-7","3"],["-5,0","-2"],["7,3,-5,0","10,7,3"],["-5,-2","7,3"],["2,-5,-2","5"],["3,-9,-4","","","-4"],["","-2,-4"],["3,-4,-9",""],["-4","3"],["5,-7,-2,2","3"],["8,-7,-2,5","8,5"],["7,3","-4,-7"],["2","2,-7,-5"],["3,-5,0","3"],["3","-2,-5,0"],["5,-9,-4,2",""],["3,-4","3"],["5,-7,-2,2","3"],["3","8,-7,-2,5"],["7,-2,-9,3",""],["7,-5,2,5","5","3","2"],["3,-5,0","","","0"],["3","7,-5,0,3"],["10,-4,-9,7,3","3"],["3","3,-4,-9"],["5,-7,2,-2","7,3"],["5,2,-7,-2","3"],["3,-2,-9",""],["2","2,-5,-7"],["3,-5,0","3"],["3","-2,-5,0"],["5,-9,-4,2",""],["3,-4","3"],["5,-7,-2,2","3"],["3","8,-7,-2,5"],["7,-2,-9,3",""],["7,-5,2,5","5","3","2"],["3,-5,0","","","0"],["3","7,-5,0,3"],["-5,-2,8,5","7,3"],["-5,-2,5","3"],["-9,-4,5,3",""],["-9,-4","-2"],["-4,-9,-2","-2"],["-4,-9,7,3","5,3"],["-7,-2,5,2",""],["3","-7,2,-2"],["-7,2,-4",""],["-5,-7,7,3","3"],["-9,-4,3","","-4,-2","-2"],["-7,-2,5,2","","3,-2","5"],["-5,0,7,3","","0,10,7,3","10,7,3"],["-5,-2,12,7,3","","-2,7,3","5"],["-9,-4,3","3","-4,7,3","7,3"],["-7,-2,5,2","3","-2,3","5,2"],["-5,0,7,3","","0,10,3,7",""],["-5,-2,7,3","","-2",""],["-9,-4,3","","-4,-2",""],["-7,-2,5,2","","-2,3","5"],["0,-5,7,3","","0,10,3,7",""],["-5,-2,7,3","","-2,5,3","3"],["-9,-4,3","","-4,7,3",""],["-7,-2,5,2","","-2,7,5,2",""],["-9,-5,3","","-5,-2",""],["-9,-5","","0","2"],["-9,-4,3","","-4,-2","-2"],["-7,-2,5,2","","3,-2","5"],["-5,0,7,3","","0,10,7,3","10,7,3"],["-5,-2,12,7,3","","-2,7,3","5"],["-9,-4,3","3","-4,7,3","7,3"],["-7,-2,5,2","3","-2,3","5,2"],["-5,0,7,3","","0,10,3,7",""],["-5,-2,7,3","","-2",""],["-9,-4,3","","-4,-2",""],["-7,-2,5,2","","-2,3","5"],["0,-5,7,3","","0,10,3,7",""],["-5,-2,7,3","","-2,5,3",""],["-9,-4,3","","-4,7,3",""],["-7,-2,5,2","","-2,7,5,2",""],["-9,-5,3","","-5,-2",""],["-9,-5","","7,3","7,3,10"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-5,0,3,7","","0",""],["-5,-2,3,7","","3,-2,5","3"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-9,-5,3","","-5,-2",""],["-9,-5,3","","3,5","3,10,7"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,7",""],["-5,-2,3","","-2,7,3",""],["-9,-4,3,5","","7,3,-4",""],["-7,-2,2,5","","-2,2,5,10",""],["-5,0,3,7","","0",""],["-5,-2,3,7","","3,-2,5","3"],["-9,-4,3,12,7","","3,7,-4,12",""],["-7,-2,12,3,7","","-2,3,10,7","3,7"],["-5,0,3,5","","0,3,14,10",""],["-5,-2,15,10,3","","-2,3,7","5"],["-9,-4,0","","7,3,-4",""],["-7,-2,2,5,10","","-2,7,3","5"],["-9,-5,3","","-5,-2",""],["-5,-9",""],"","","",""]`;


			ctx.imageSmoothingEnabled=false;
			//ctx.fillStyle='#888';ctx.fillRect(0,0,c.width,c.height);
			dat.oninput=()=>{seq.events=JSON.parse(dat.value);scrw.style.width=a2c(seq.events,1)+'px';}
			(onresize=()=>{c.width=c.parentNode.clientWidth*res;c.height=240*res;ctx.scale(res,res);dat.oninput();})();
			scr.onwheel=e=>{e.preventDefault();scr.scrollLeft+=Math.abs(e.deltaX)>Math.abs(e.deltaY)?e.deltaX:e.deltaY;};
			scr.onscroll=()=>a2c(seq.events);
		</script>
	</body>
</html>
