<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>McbeEringi glyph_gen</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
	</head>
	<body>
		<style>
			:root{background:#222;color:#fff;font-family:sans-serif;image-rendering:pixelated;}
			#disp{box-shadow:0 0 0 1px #888;overflow:hidden;display:flex;flex-wrap:wrap;}
			#disp>p{width:6.25%;height:6.25%;margin:0;padding:0;vertical-align:top;overflow:hidden;position:relative;vertical-align:text-bottom;}
			p span{margin:0;padding:0;}label span:not(#dpr){display:inline-block;width:6ex;text-align:right;margin-right:1ex;}a{background:#888;}
			input{background-color:#0000;color:#fff;border:none;border-radius:0;border-bottom:2px solid #888;font-size:14px;}
			input:focus{outline:none;border-bottom:2px solid #48f;transition:.5s;}
			.clear_fix::after{content:"";clear:both;display:block;}
			progress{width:100%;}pre{line-height:14px;font-size:12px;margin:0;}textarea{width:24em;height:42px;line-height:14px;font-size:12px;font-family:monospace;}
		</style>
		<style id="fstyle"></style>
		<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.0.0-rc.7/dist/html2canvas.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/jszip@3.5.0/dist/jszip.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.2/dist/FileSaver.min.js"></script>
		<script src="https://mcbeeringi.github.io/src/requestIdleCallback.min.js"></script>

		<div id="configp">
			<label><span>img:</span><input id="img_s" type="number" value="512" onchange="i_s(this.value);render();"><span id="dpr"></span> px²</label><br>
			<label><span>size:</span><input id="font_s" type="number" value="32" oninput="f_s(this.value);"onchange="render();">px</label><br>
			<label><span>font:</span><input id="font_f" value="sans-serif" onchange="document.body.style.fontFamily=this.value+',sans-serif';render();"></label> or <input type="file" onchange="f_r(this)" accept=".ttf,.otf,.woff,.woff2"><br>
			<label><span>block:</span><input id="men" value="00" onchange="set(this.value);render();"></label><br>
			<label><span>debug:</span><input type="checkbox" onchange="debug(this.checked);"></label><br>
		</div>
		<br>
		<button onclick="exp(expl.value);" id="expb">export bmp</button><br>
		black list:<br><textarea id="expl" oninput="this.value=this.value.toUpperCase().replace(/[^\dABCDEF,]/,'')">D8,D9,DA,DB,DC,DD,DE,DF,E0,E1,E2,E3,E4,E5,E6,E7,E8,E9,EA,EB,EC,ED,EE,EF,F0,F1,F2,F3,F4,F5</textarea><br>
		<progress value="0" id="pbar0"></progress><br>
		<progress value="0" max="100" id="pbar1"></progress><br>
		<pre id="log"></pre><pre id="elog"></pre>
		<br>
		<a id="dl" download href="">……</a><br>
		<div id="disp"></div>
		<img id="img" style="width:50vmin;">

		<script>
			window.scrollTo(0,0);
			dpr.textContent='*'+window.devicePixelRatio;
			/////base
			var p256='';for(var i=0;i<256;i++)p256+='<p><span></span></p>';disp.insertAdjacentHTML('beforeend',p256);
			const	i_s=x=>{disp.style.width=x+'px';disp.style.height=x+'px';}
			i_s(img_s.value);
			const	f_s=x=>disp.querySelectorAll('p').forEach(e=>{e.style.fontSize=`${x}px`;e.style.lineHeight=`${x}px`;});
			f_s(font_s.value);
			const f_r=f=>{
				var fname=f.files[0].name;fname=[fname.slice(0,(fname.lastIndexOf('.')-1>>>0)+1),fname.slice((fname.lastIndexOf('.')-1>>>0)+2)];
				const format={"ttf":"truetype","otf":"opentype","woff":"woff","woff2":"woff2"};
				fstyle.textContent=`@font-face{font-family:"${fname[0]}";src:url(${URL.createObjectURL(f.files[0])})format("${format[fname[1]]}");}`;
				font_f.value=fname[0];document.body.style.fontFamily=fname[0]+',sans-serif';render();
			}
			const debug=x=>disp.querySelectorAll('#disp>p').forEach(e=>{e.style.boxShadow=x?'0 0 1px #fff4':'';e.style.textDecoration=x?'underline #fff8':'';});
			const set=x=>disp.querySelectorAll('p span').forEach((e,i)=>e.textContent=String.fromCodePoint(parseInt(x,16)*0x100+Number(i)));
			set(men.value);
			const render=()=>{
				html2canvas(document.getElementById("disp"),{"backgroundColor":null}).then(c=>{
					dl.href=c.toDataURL();
					dl.download=`glyph_${men.value}.png`;
					dl.innerText=`download as ${dl.download}`;
					img.src=dl.href;
				});
			}
			render();

			/////export
			const exp=(blist)=>{
				elog.textContent='';pbar0.value=0;pbar1.value=0;expb.disabled=true;expb.textContent='Running…';configp.style.opacity=0.2;configp.style.pointerEvents='none';
				var arr=[...Array(256).keys()].map(x=>('00'+x.toString(16).toUpperCase()).slice(-2));
				if(blist)arr=arr.filter(x=>!(blist.split(',').includes(x)));
				var arr_=[],zip=new JSZip(),fontFolder=zip.folder("font"),arrl=arr.length;pbar0.max=arrl;
				const exppost=()=>{
					console.groupEnd();
					set(men.value);configp.style.opacity=1;configp.style.pointerEvents='auto';
					zip.generateAsync({type:"blob"},d=>{pbar1.value=d.percent;log.textContent=`step 2/2 packaging… ${d.percent.toFixed(2)}%`;})
						.then(c=>{console.log('done');saveAs(c,`${font_f.value}_bmp.zip`);expb.textContent='export bmp';expb.disabled=false;})
				};
				const expmain=()=>{
					console.group();console.log(arr);
					arr.map((x,i)=>requestIdleCallback(()=>{
						set(x);
						html2canvas(document.getElementById("disp"),{"backgroundColor":null,"scrollX":0,"scrollY":-window.pageYOffset}).then(c=>c.toBlob(b=>{
							fontFolder.file(`glyph_${x}.png`,b);
							if(x=='00')fontFolder.file('default8.png',b);
							log.textContent=`step 1/2 rendering… ${(++pbar0.value/arrl*100).toFixed(2)}%   ( ${('00'+pbar0.value).slice(-3)} / ${arrl}  ${x} )`;
							console.log(x);
							if(i==arr.length-1){if(arr_.length){arr=arr_;arr_=[];elog.textContent=' fix…\n';expmain();}else{elog.textContent='rendering done.';exppost();}}
						})).catch(e=>{arr_.push(x);elog.textContent+=`${x} `;});
					}));
				}
				expmain();
			};

		</script>
	</body>
</html>
