<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<script async src="https://mcbeeringi.github.io/src/gas.js"></script>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi poly</title>
	<meta name="description" content="mcbe model json converter">
	<link rel="icon" type="image/svg+xml" href="../../img/icon.svg">
	<link rel="apple-touch-icon" href="../../img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="../../src/style.css">
</head>
<body>
	<style>
		.input{font-family:monospace;width:100%;tab-size:2;}
	</style>
	<h1>poly</h1>
	<hr>
	<input type="file" id="inp" class="button">
	<textarea id="cfg" class="input" spellcheck="false">{
	v:(x,i,a)=>[x[2],x[1],x[0]].map(y=>y*16),//vertices for .obj
	vn:(x,i,a)=>[x[0],x[1],x[2]],//normals for .obj
	vt:(x,i,a)=>[x[0],x[1]],//uvs for .obj
	fmt:bones=>({//format
		format_version:'1.12.0',
		'minecraft:geometry':[{
			description:{
				identifier:'geometry.armor_stand',
				texture_width:64,
				texture_height:64,
				visible_bounds_width:1,
				visible_bounds_height:1,
				visible_bounds_offset:[0,0,0]
			},
			bones
		}]
	}),
	file_name:'armor_stand.geo.json'
}</textarea>
	<button id="runbtn" class="button">run</button>
	<hr>
	<pre id="log" style="white-space:pre-wrap;">build:2211010</pre>
	<button id="cpbtn" class="button" disabled>copy to clipboard</button>
	<button id="dlbtn" class="button" disabled>download</button>


	<script type="module">
		import TA from'https://mcbeeringi.github.io/ta/ta+.mjs';
		const
			wurl=URL.createObjectURL(new Blob([`'use strict';onmessage=m=>Object.getPrototypeOf(async _=>_).constructor(m.data)();`])),
			worker=new Worker(wurl),
			obj2mc=(w,q)=>((
				spl=(x,i)=>x.split(/\s+/,i).slice(1),spln=(...x)=>spl(...x).map(_=>+_),
				uuidgen=w=>(w=[...crypto.getRandomValues(new Uint8Array(16))].flatMap(x=>[x>>4,x&0xf]),Array.from('00000000-0000-4000-1000-000000000000',x=>([_=>w.pop().toString(16),_=>'89ab'[w.pop()%4]][x]||(_=>x))()).join('')),
				core=({w,_v=0,_vt=0,_vn=0}={},round=(x,y=1e6)=>Math.round(x*y)/y,
						og=(w.match(/^[og] (.+)$/m)||[,uuidgen()])[1],vt=[[0,0],...(w.match(/^vt .+$/gm)||[]).map(x=>spln(x,3))].map(q.vt),vn=[[0,1,0],...(w.match(/^vn .+$/gm)||[]).map(x=>spln(x,4))].map(q.vn),
						v=(w.match(/^v .+$/gm)||[]).map((x,i,a)=>(x=spln(x),(x.length==4?_=>(x[3]=1/x[3],x.slice(0,3).map(y=>round(y*x[3]))):_=>x.slice(0,3))())).map(q.v)
					)=>({w:{
						name:og,pivot:v.length&&v.reduce((a,x)=>a.map((y,i)=>y+x[i])).map(x=>round(x/v.length)),
						poly_mesh:{
							normalized_uvs:true,positions:v,normals:vn,uvs:vt,
							polys:(w.match(/^f .+$/gm)||[]).flatMap(x=>(
								x=spl(x).map(y=>(y=y.split('/'),[y[0]-1-_v,y[2]?y[2]-_vn:0,y[1]?y[1]-_vt:0])),
								new Array((x.length-1)/2|0).fill().reduce(a=>(a.a.push(x[a.x+2]?[x[0],x[a.x++],x[a.x++],x[a.x]]:[x[0],x[a.x++],x[a.x],x[0]]),a),{a:[],x:1}).a
							))
						}
					},_v:v.length,_vt:vt.length-1,_vn:vn.length-1})
			)=>q.fmt(w.split(/\n(?=[og])/).reduce((a,x)=>(a.push(core({...a[a.length-1],w:x})),a),[{}]).flatMap(x=>x.w&&x.w.poly_mesh.polys.length?[x.w]:[])))(),
			mqo2mc=(w,q)=>(
				w=Object.fromEntries((w.match(/Object "[^\n]*" \{.*?\n\}/sg)||[]).map(x=>(
					x=x.replace(/\t+/g,'').match(/.+/g),
					x=[x[0].slice(8,-3),x.slice(1,-1).reduce((a,y)=>(isNaN(y[1])?(y=='}'?0:a.a[a.x=y.split(' ',1)[0]]=y.includes('{')?[]:(y=y.split(' ').slice(1)).length>1?y.map(_=>+_):+y[0]):a.a[a.x].push(y),a),{a:{},x:''}).a],
					x[1]=x[1].vertex&&x[1].face?(
						x[1].face.map((y,v,n)=>(
							v=(y.match(/ V\((.+?)\)/)||'0 ')[1].split(' ').map(z=>x[1].vertex[z]),
							n=v.reduce((a,z)=>(z=z.split(' '),a.map((_,i)=>+z[i]+_)),[0,0,0]),//TODO: 平均じゃなくて外積
							{
								v,
								vt:((y.match(/ UV\((.+?)\)/)||'0 ')[1].match(/[\d\.]+ [\d\.]+/g)||[]),
								n:n.map(z=>z/Math.hypot(...n)).join(' ')
							}
						))
					):null,
					x
				))),
				console.log(w)
			);

		worker.onmessage=async m=>(
			cpbtn.onclick=async()=>(await navigator.clipboard.writeText(m.data),log.textContent+=' copied!'),
			dlbtn.onclick=_=>(_=document.createElement('a'),_.download=Function('return '+cfg.value)().file_name,_.href=URL.createObjectURL(new Blob([m.data])),_.click(),URL.revokeObjectURL(_.href)),
			cpbtn.disabled=dlbtn.disabled=false,log.textContent='done!'
		);
		runbtn.onclick=w=>(w=({
			obj:async()=>worker.postMessage(`postMessage(JSON.stringify((${obj2mc})(${JSON.stringify(await new Response(inp.files[0]).text())},${cfg.value})));`),
			mqo:async()=>mqo2mc(await new Response(inp.files[0]).text())//worker.postMessage(`postMessage(JSON.stringify('ﾆｬｰﾝ'));`),
		}[inp.files[0]&&inp.files[0].name.match(/[^\.]+$/)[0].toLowerCase()]),w?(w(),log.textContent='please wait...'):(log.textContent='file extention must be .obj, or .mqo.'));

		cpbtn.disabled=dlbtn.disabled=true;TA.editor(cfg);
		onbeforeunload=_=>URL.revokeObjectURL(wurl,worker.terminate());
		onunhandledrejection=onerror=e=>log.textContent=e.reason||e;
	</script>
</body>
</html>
