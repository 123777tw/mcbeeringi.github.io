<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>McbeEringi obj2mcbe</title>
		<style media="screen">
			:root,textarea,input{background-color:#222;color:#fff;font-family:menlo,monospace;font-size:13px;}
			h1,h2{margin:2px;}a:link{color:#48f}.box{background-color:#333;padding:4px;}
			textarea{background-color:#0000;line-height:14px;min-height:92px;max-height:448px;width:calc(100% - 8px);overflow:scroll;resize:vertical;}
			#log{line-height:14px;max-height:448px;overflow:scroll;background-color:#333;}
			.inp{background-color:#0000;display:inline-block;border:none;border-bottom:2px solid #888;border-radius:0;min-width:18em;max-width:100%;margin-bottom:8px;outline:none;transition:.2s;}
			.inp:focus{border-bottom-color:#48fc;}
			.button{background-color:#555;padding:8px;border-radius:4px;user-select:none;-webkit-user-select:none;display:inline-block;}
			.button:active{background-color:#48fc;}
			.file{max-width:320px;height:90px;position:relative;border-radius:5px;border:1px solid #888;overflow:hidden;}
			.file input[type=file]{position:absolute;cursor:pointer;margin:0;width:100%;height:100%;opacity:0;}
			.file div{position:absolute;top:50%;transform:translateY(-50%);text-align:center;width:100%;pointer-events:none;}
		</style>
	</head>
	<body>
		<h1>obj2mcbe</h1>
		<br>
		<div class="box">
			<h2>.obj</h2>
			<span style="float:right;">16^3=1block</span>
			<form id="inpm" onchange="inpt.style.display=['block','none'][this.m.value];inpf.style.display=['none','block'][this.m.value];">
				<label><input type="radio" name="m" value="1" checked>file</label><br>
				<label><input type="radio" name="m" value="0">text</label>
			</form>
			<div id="inpt" style="display:none;">
				<textarea id="tinp"></textarea>
			</div>
			<div id="inpf">
				<br>
				<div class="file"><input type="file" id="finp" onchange="read(this)"><div id="finpl">Drag & Drop or click to select</div></div>
			</div>
		</div>
		<br>
		<div class="box">
			<h2>settings</h2>
			position:<span contenteditable="true" class="inp" id="vfx">[v[2],v[1],v[0]];</span><br>
			<span style="color:#0000">__</span>normal:<span contenteditable="true" class="inp" id="vnfx">[vn[0],vn[1],vn[2]];</span><br>
			<span style="color:#0000">__</span>tex_uv:<span contenteditable="true" class="inp" id="vtfx">[vt[0],vt[1]];</span><br>
			<br>
			<label>format(1.8.0):<input type="checkbox" id="frm" onchange="frmc.style.display=this.checked?'block':'none';outtitle.textContent=this.checked?'mcbe geometry':'mcbe bones(poly_mesh)'"></label><br>
			<div id="frmc" style="display:none;">
				geometry.<input class="inp" id="mname" value="armor_stand" oninput="this.value=this.value.replace(/[^\w.]+/g,'')"><br>
			</div>
		</div>
		<br>
		<span class="button" onclick="main();this.textContent='done!';setTimeout(()=>this.textContent='run',1000);">run</span><br>
		<pre id="log"></pre>
		<br>
		<div class="box">
			<h2 id="outtitle">mcbe bones(poly_mesh)</h2>
			<form id="outm" onchange="outt.style.display=['block','none'][this.m.value];outf.style.display=['none','block'][this.m.value];">
				<label><input type="radio" name="m" value="1" checked>file</label><br>
				<label><input type="radio" name="m" value="0">text</label><br>
			</form>
			<div id="outt" style="display:none;">
				<textarea id="tout"></textarea><br>
				<span class="button" onclick="if(copy(tout.value))this.textContent='copied!';setTimeout(()=>this.textContent='copy',1000);">copy</span>
			</div>
			<div id="outf">
				<br>
				<a id="fout">Press run first to generate file</a>
			</div>
		</div>
		<script>
			var reader = new FileReader(), fname = "unknown";
			const fx = str=>str.replace(/\n/g,"").split(" ").map(x=>x.replace(/0+$/g,"")).slice(1).map(x=>Number(x));
			const time = ()=>{var d=new Date();return d.getHours()+":"+d.getMinutes()+":"+(d.getSeconds()+d.getMilliseconds()*1e-3)+" ";}
			function read(_this) {
				fname=_this.files[0].name;
				finpl.textContent="Drag & Drop or click to select";
				reader.addEventListener("progress",(x)=>finpl.textContent=x.loaded/x.total+"% loaded…",false);
				reader.addEventListener("load",(x)=>finpl.textContent=fname+" "+(x.total>=1e9?Math.round(x.total/1e7)/1e2+"GB":(x.total>=1e6?Math.round(x.total/1e4)/1e2+"MB":(x.total>=1e3?Math.round(x.total/1e1)/1e2+"KB":x.total+"byte"))),false);
				reader.addEventListener("error",()=>finpl.textContent="Loading failed: "+fname,false);
				reader.addEventListener("loadend",(x)=>console.log(x),false);
				reader.readAsText(_this.files[0]);
			}
			function core(s,posf,nf,uvf) {
				//log.textContent += time()+"[info] started…\n";
				var o = s.match(/^o\s.+$/m);
					if(o){o = o[0].replace(/\n/g,"").replace(/^o\s/,"");}
					else{log.textContent += time()+"[info] o not found\n";o="poly"}
				var pos = s.match(/^v\s.+$/gm);
					if(!pos){log.textContent += time()+"[error] v not found\n";return;};
					pos = pos.map(fx).map(v=>eval(vfx.textContent));
				var n = s.match(/^vn\s.+$/gm);
					if(n){n = n.map(fx);}
					else{log.textContent += time()+"[info] vn not found\n";n=[[0,1,0]];}
					n = n.map(vn=>eval(vnfx.textContent));
				var uv = s.match(/^vt\s.+$/gm);
					if(uv){uv = uv.map(fx);}
					else{log.textContent += time()+"[info] vt not found\n";uv=[[0,0]];}
					uv = uv.map(vt=>eval(vtfx.textContent));
				var pol = s.match(/^f\s.+$/gm);
					if(pol)pol = pol.map(str=>{str=str.replace(/\n/g,"").split(" ").map(x=>{x=x.split("/").map(x=>x?x-1:x);return [x[0]-posf,x[2]?x[2]-nf:0,x[1]?x[1]-uvf:0]}).slice(1);return [str[0],str[1],str[2],str[str[3]?3:0]]});
					else{log.textContent += time()+"[info] f not found… '"+o+"' skipped\n";return ["",pos.length,n.length,uv.length];}
				console.log(o,pos,uv,n,pol);
				s =
					'{"name":"'+o+'","pivot":[0,0,0]'+
					',"poly_mesh":{"normalized_uvs":true,"positions":'+JSON.stringify(pos)+
					',"normals":'+JSON.stringify(n)+',"uvs":'+JSON.stringify(uv)+
					',"polys":'+JSON.stringify(pol)+'}},';
				log.textContent += time()+"[info] '"+o+"' done\n"
				return [s,pos.length,n.length,uv.length];
			}
			function main() {
				log.textContent = time()+"[info] all convertions started\n";
				var posf=0,nf=0,uvf=0,o=fname,diffuse="",tmp;
				var s = [tinp.value,reader.result][inpm.m.value];
				if(!s){log.textContent += time()+"[error] Input not found\n";return;}
				if(s.match(/^o\s.+$/m))s = ("o\n#\n"+s).split(/\n(?=o)/).slice(1);
				else s=[s];
				console.log(s);
				for(var i=0; i<s.length; i++) {
					tmp = core(s[i],posf,nf,uvf);
					if(tmp){diffuse+=tmp[0]; posf+=tmp[1]; nf+=tmp[2]; uvf+=tmp[3];}
					else {return;}
				}
				diffuse = diffuse.slice(0,-1);
				if(frm.checked){
					o = mname.value;
					diffuse = '{"format_version":"1.8.0","geometry.'+o+'":{"bones":['+diffuse+']}}';
				}
				tout.value = diffuse;
				fout.href = "data:,"+encodeURI(diffuse);
				fout.download = o+".geo.json";fout.textContent = 'save as "'+fout.download+'"';
				log.textContent += time()+"[info] all convertions completed";
			}
			function copy(string) {
				var tmp = document.createElement("div");
				var pre = document.createElement("pre");
				pre.style.webkitUserSelect = "auto";
				pre.style.userSelect = "auto";
				tmp.appendChild(pre).textContent = string;
				var s = tmp.style;
				s.position = "fixed";
				s.right = "200%";
				document.body.appendChild(tmp);
				document.getSelection().selectAllChildren(tmp);
				var result = document.execCommand("copy");
				document.body.removeChild(tmp);
				return result;
			}
		</script>
	</body>
</html>
