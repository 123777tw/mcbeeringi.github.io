<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<!-- <script async src="https://mcbeeringi.github.io/src/gas.js"></script> -->

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi slime_chunk_be</title>
	<meta name="description" content="mcbe slime chunk calculator">
	<link rel="icon" type="image/svg+xml" href="../../img/icon.svg">
	<link rel="apple-touch-icon" href="../../img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="../../src/style.css">
</head>
<body>
<style>canvas{display:block;width:min(100%,720px);margin:0 auto;backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);cursor:grab;}canvas:active{cursor:grabbing;}label{white-space:nowrap;}</style>
<h1>slime_chunk_be</h1>
<hr>
<label>x:<input type="number" id="ipx" value="0" class="zab"></label>
<label>z:<input type="number" id="ipz" value="0" class="zab"></label>
<label>size:<input type="range" id="inps" value="5" min="1" max="10" step="any"></label>
<button id="dlbtn" class="zab bgca">dl img</button>
<canvas></canvas>

<script>
const
ctx=document.querySelector('canvas').getContext('2d'),
w={region:{}},
crct=[...Array(256)].map((_,n)=>[...Array(8)].reduce(c=>(c&1)?0xedb88320^(c>>>1):c>>>1,n)),crc=(buf,crc=0)=>~buf.reduce((c,x)=>crct[(c^x)&0xff]^(c>>>8),~crc)// https://www.rfc-editor.org/rfc/rfc1952
adler=data=>{let a=1,b=0,len=data.length,tlen,i=0;while(len>0){len-=(tlen=Math.min(1024,len));do{b+=(a+=data[i++]);}while(--tlen);a%=65521;b%=65521;}return(b<<16)|a;},// https://ja.wikipedia.org/wiki/Adler-32
slime=m=>{// der MersenneTwister
	m=Math.imul(m[0],0x1f1f1f1f)^m[1];// seed
	const f=(x,y)=>Math.imul(x^x>>>30,0x6c078965)+y,a=m&0x80000000|(m=f(m,1))&0x7fffffff;
	for(let i=2;i<398;i++)m=f(m,i);
	m^=a>>> 1 ^[0,0x9908b0df][a&1];
	m^=m>>>11;
	m^=m<<  7 &0x9d2c5680;
	m^=m<< 15 &0xefc60000;
	m^=m>>>18;
	return!((m>>>0)%10);// slime
},
wmain=p=>(_=>(
	_=[...Array(256)].flatMap((_,i,{length:m})=>(_=[...Array(4)].reduce((a,_,j,{length:n})=>(
		_={i:i*n+j,l:Math.sqrt(m*n)},_=[p[0]*_.l+_.i%_.l,p[1]*_.l+(_.i/_.l|0)],
		(slime(_)<<1|(_[0]^_[1])&1)<<(8/n*(n-1-j))|a
	),0),i%8?[_]:[0,_])),
	_=[73,68,65,84, 8,29, 1, 32,1, 223,254, ..._,...(_=>[_>>>24&255,_>>>16&255,_>>>8&255,_>>>0&255])(adler(_))],// IDAT zlib CMF:08 FLG:1d uncompressed final block length:256+32=288(little endian)
	'data:image/png;base64,'+btoa(String.fromCharCode(// big endian
		137,80,78,71,13,10,26,10,// header
		0,0,0,13,73,72,68,82, 0,0,0,32,0,0,0,32, 2,3, 0,0,0, 14,20,146,103,// IHDR: 32*32 2bit indexed
		0,0,0,12,80,76,84,69, 128,128,128, 128,128,128, 0,255,0, 0,255,0, 32,242,49,113,// PLTE
		0,0,0,4,116,82,78,83, ...((p[0]^p[1])&1?[32,64,224,192, 166,33,117,56]:[128,64,224,240, 205,147,92,145]),// tRNS
		0,0,1,43,..._,...(_=>[_>>>24&255,_>>>16&255,_>>>8&255,_>>>0&255])(crc(_)),// IDAT
		0,0,0,0,73,69,78,68,174,66,96,130// IEND
	))
))(),
wurl=URL.createObjectURL(new Blob(['onmessage=m=>Object.getPrototypeOf(async _=>_).constructor("w",m.data.main)(m.data);'])),
worker=[...Array(8)].reduce((a,x=new Worker(a.x))=>(
	x.onmessage=m=>(m=m.data,Object.assign(new Image(),{onload(){w.region[m.key]&&w.region[m.key].f({p:m.p,img:this});},src:m.src})),
	x.postMessage({crct,main:`self.crct=w.crct;self.crc=${crc};self.adler=${adler};self.slime=${slime};self.wmain=${wmain};onmessage=m=>postMessage({p:m.data,key:m.data.join(),src:wmain(m.data)});`}),
	a.a.push(x),a
),{x:URL.createObjectURL(new Blob(['onmessage=m=>Object.getPrototypeOf(async _=>_).constructor("w",m.data.main)(m.data);'])),a:[],_(){URL.revokeObjectURL(this.x);return this.a;}})._(),
req=async x=>(x={p:x,key:x.join()},w.region[x.key]||await((_,f,r)=>(_=new Promise((x,y)=>(f=x,r=y)),_.f=f,_.r=r,w.region[x.key]=_,worker[Object.keys(w.region).length%worker.length].postMessage(x.p),_))()),

draw=(_,s=Math.pow(2,inps.value),p=[+inpx.value,+inpz.value])=>(
	_={

	}
)



ctx.canvas.height=ctx.canvas.width=1024;
self.t0=performance.now();
Promise.all([...Array(4096)].map(async()=>document.body.append((await req([Math.random()*4096|0,Math.random()*4096|0])).img.cloneNode()))).then(_=>alert((performance.now()-t0)/1000));


</script>
</body>
</html>
