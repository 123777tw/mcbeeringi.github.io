<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>McbeEringi fsh</title>
		<link rel="stylesheet" href="../menu.css">
		<style>
			:root{--pos:fixed;--menu_h:200px;font-family:sans-serif;background-color:#222;color:#eee;image-rendering:pixelated;}
			canvas{position:fixed;border:1px solid #f44;left:200%;}
			.flex{display:flex;justify-content:space-around;flex-wrap:wrap;align-items:flex-start;}
			#diffuse{width:100%;max-width:640px;height:100%;object-fit: contain;}
			.box{min-width:200px;min-height:320px;height:50vh;flex-grow:1;display:block;border:1px solid #888;margin:2px;}
			.file{width:160px;height:120px;position:relative;border-radius:5px;border:1px solid #888;overflow:hidden;text-shadow:0 0 4px #000;background-size:contain;background-repeat:no-repeat;background-position:center;background-color:#000;margin:2px 0;}
			.file input[type=file]{position:absolute;cursor:pointer;margin:0;width:100%;height:100%;opacity:0;}
		</style>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		<div class="flex">
			<div class="box">
				<img id="diffuse" src="" alt="diffuse">
			</div>
			<pre class="box" contenteditable="true" id="fsh" oninput="compile();">precision mediump float;
uniform float time;
uniform vec2 resolution;
void main(){
	vec2 p = gl_FragCoord.xy/resolution;
	gl_FragColor=vec4(p,sin(time)*.5+.5,1);
}</pre>
		</div>
		<div class="flex" style="max-width:800px;margin:0 auto;">
			<div class="file" id="inp0d"><input type="file" id="inp0" accept="image/*" onchange="read(this)">tex0</div>
			<div class="file" id="inp1d"><input type="file" id="inp1" accept="image/*" onchange="read(this)">tex1</div>
			<div class="file" id="inp2d"><input type="file" id="inp2" accept="image/*" onchange="read(this)">tex2</div>
			<div class="file" id="inp3d"><input type="file" id="inp3" accept="image/*" onchange="read(this)">tex3</div>
		</div>
		<pre id="log"></pre>
		<div class="menu">
			<input type="checkbox" id="example">
			<label for="example"></label>
			<div><div></div></div>
			<div>
				<p>menu</p>
				<p>menu</p>
				<p>menu</p>
			</div>
		</div>
		<script>
		var imgurl=[null,null,null,null];
		function read(_this) {
			var reader = new FileReader();
			var d = document.getElementById(_this.id+"d").style;
			reader.addEventListener('load', ()=>{d.backgroundImage="url('"+reader.result+"')";imgurl[_this.id.slice(-1)]=reader.result;}, false);
			reader.addEventListener('error',()=>{d.backgroundImage="linear-gradient(#f0f,#f0f)";},false);
			reader.readAsDataURL(_this.files[0]);
			console.log(_this.id,imgurl,reader);
		}

		var c = document.getElementById("canvas");
		c.width = 16;c.height = 16;
		var gl = c.getContext("webgl") || c.getContext("experimental-webgl");
		gl.enable(gl.CULL_FACE);
		gl.frontFace(gl.CCW);//gl.frontFace(gl.CW);
		gl.enable(gl.DEPTH_TEST);
		gl.depthFunc(gl.LEQUAL);
		gl.enable(gl.BLEND);
		gl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE);
		gl.getExtension("OES_standard_derivatives");
		function create_shader(f){
			if(f){var shader = gl.createShader(gl.FRAGMENT_SHADER);var src = fsh.textContent}
			else{var shader = gl.createShader(gl.VERTEX_SHADER); var src = "attribute vec2 UV;void main(){gl_Position=vec4(UV,0,1);}";}
			gl.shaderSource(shader, "#define round(x) floor(x+.5)\n"+src);
			gl.compileShader(shader);
			if(gl.getShaderParameter(shader, gl.COMPILE_STATUS))return shader;
			else log.innerText += gl.getShaderInfoLog(shader);
		}
		function create_program(vsh, fsh){
			var program = gl.createProgram();
			gl.attachShader(program, vsh);
			gl.attachShader(program, fsh);
			gl.linkProgram(program);
			log.innerText += gl.getProgramInfoLog(program);
			if(gl.getProgramParameter(program, gl.LINK_STATUS)){
				gl.useProgram(program);
				return program;
			}
		}
		function compile(){
			log.innerText = "";
			prg = create_program(create_shader(0),create_shader(1));}
		compile();
		//attribute
		var UV = gl.getAttribLocation(prg, "UV");
		var uv_v = gl.createBuffer();
		gl.bindBuffer(gl.ARRAY_BUFFER, uv_v);
		gl.enableVertexAttribArray(UV);
		gl.vertexAttribPointer(UV, 2, gl.FLOAT, false, 0, 0);
		gl.bindBuffer(gl.ARRAY_BUFFER, null);
		gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.createBuffer());//ibo
			gl.bindBuffer(gl.ARRAY_BUFFER, uv_v);
			gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, 1,1]), gl.STATIC_DRAW);
			gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Int16Array([0,1,2, 3,2,1]), gl.STATIC_DRAW);
		//texture
		var texture = [];
		function tex(){
			for (var i=0; i<4; i++){
				var img = new Image();
				img.onload = function() {
					var tex = gl.createTexture();
					gl.bindTexture(gl.TEXTURE_2D, tex);//バインドセット
					gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);//読み込み
					gl.generateMipmap(gl.TEXTURE_2D);//生成
					gl.bindTexture(gl.TEXTURE_2D, null);//バインド解除
					texture[i] = tex;
				}
				img.src = imgurl[i];
			}
		}
		tex();

		var t = 0;
		var fps = 60;
		var prc;//二重起動防止
		function main(){
			clearTimeout(prc);
			t+=1/fps;
			gl.clearColor(0,0,0,0);
			gl.clearDepth(1.);
			gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
			var uniform = [//uniformLocationの取得
				gl.getUniformLocation(prg, "time"),
				gl.getUniformLocation(prg, "resolution"),
				gl.getUniformLocation(prg, "tex0"),
				gl.getUniformLocation(prg, "tex1"),
				gl.getUniformLocation(prg, "tex2"),
				gl.getUniformLocation(prg, "tex3")
			];
			gl.uniform1f(uniform[0], t);
			gl.uniform2fv(uniform[1], [c.width,c.height]);

			gl.activeTexture(gl.TEXTURE0);
			gl.bindTexture(gl.TEXTURE_2D, texture[0]);
			gl.uniform1i(uniform[2], 0);
			gl.activeTexture(gl.TEXTURE1);
			gl.bindTexture(gl.TEXTURE_2D, texture[1]);
			gl.uniform1i(uniform[3], 1);
			gl.activeTexture(gl.TEXTURE1);
			gl.bindTexture(gl.TEXTURE_2D, texture[2]);
			gl.uniform1i(uniform[4], 2);
			gl.activeTexture(gl.TEXTURE1);
			gl.bindTexture(gl.TEXTURE_2D, texture[3]);
			gl.uniform1i(uniform[5], 3);

			gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);//モデルの描画
			gl.flush();//コンテキスト再描画
			diffuse.src = c.toDataURL();

			prc =setTimeout(main, 1000/fps);
		}
		main();
		</script>
	</body>
</html>
