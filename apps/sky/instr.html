<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<title>McbeEringi sky_instruments</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<!--iOS-->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="default">
		<meta name="apple-mobile-web-app-title" content="sky instr">
		<link rel="apple-touch-icon" href="ico_512.png">
		<!--sw-->
		<link rel="manifest" href="instr_manifest.json">
		<script>
			if('serviceWorker' in navigator)navigator.serviceWorker.register('instr_sw.js').then((reg)=>{console.log('Service worker registered.', reg);});
		</script>
	</head>
	<body>
		<script src="sky_style.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.5.45/Tone.js"></script>
		<style>
			:root{user-select:none;-webkit-user-select:none;}body{margin:0;}
			#fixed{position:fixed;width:100%;height:100%;background:linear-gradient(#0008,#0000 64px);}
			/*keyboard*/
			#kb{touch-action:none;margin:0 auto;pointer-events:none;}td{width:83px;height:83px;}
			td div{width:70px;height:70px;background-color:#8888;border-radius:16px;box-shadow:0 0 10px #8888;position:relative;cursor:pointer;margin:0 auto;z-index:0;}
			td div::before{content:"";display:block;position:absolute;width:70px;height:70px;animation:bob 1.2s ease-in-out 0s infinite alternate;background-image:url(button.png);background-size:210px auto;z-index:1;}
			td:nth-child(2n) div:not(.c)::before{background-position:-70px 0;}
			td:nth-child(2n-1) div:not(.c)::before{background-position:-140px 0;}
			td div.on_{transform:scale(.8,.8);}td div:not(.on_){transition:.1s;}td div.on::before, td div.on::after{animation:on .4s ease-in-out;transform:rotateY(0deg);}
			@keyframes bob{0%{transform:scale(1,1);}100%{transform:scale(.9,.9);}}
			@keyframes on{0%{transform:rotateY(0deg);}100%{transform:rotateY(360deg);}}
			svg{position:absolute;bottom:18px;left:50%;transform:translate(-50%);filter:drop-shadow(0 0 2px #0008);}
			/*config*/
			#cfg{top:100%;width:100%;position:absolute;background:#444c;box-shadow:0 0 16px #444c;}
			/*rotdisp*/
			.rotdisp{margin:0 auto;display:flex;justify-content:center;align-items:center;flex-wrap:wrap;touch-action:none;background:center no-repeat url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='32'%3E%3Cpolygon points='0,16 16,32 20,32 6,18 154,18 140,32 144,32 160,16 144,0 140,0 154,14 6,14 20,0 16,0' fill='%23555a'%3E%3C/polygon%3E%3C/svg%3E");}
			.rotdisp>*{position:relative;width:96px;height:96px;background:#555;border-radius:24px;margin:8px;box-shadow:0 0 8px #555;}
			.rotdisp>*::before{content:"";position:absolute;width:5px;height:5px;left:44px;top:3px;transform:rotateZ(45deg);background:#caf0f6;filter:drop-shadow(0 0 3px #caf0f6);}
			.rotdisp>*>*{position:relative;margin:10.5px;width:72px;height:72px;box-shadow:0 0 3px #222,0 0 3px #222 inset;background:#555;border-radius:50%;transition:.2s;}
			.rotdisp>*>*::before{content:"";position:absolute;width:6px;height:6px;left:33px;top:6px;transform:rotateZ(45deg);background:#caf0f6;filter:drop-shadow(0 0 3px #caf0f6);}
		</style>


		<div id="fixed">
			<table id="kb">
				<tr><td><div class="c" id="_-9"></div></td><td><div id="_-7"></div></td><td><div id="_-5"></div></td><td><div id="_-4"></div></td><td><div id="_-2"></div></td></tr>
				<tr><td><div id="_0"></div></td><td><div id="_2"></div></td><td><div class="c" id="_3"></div></td><td><div id="_5"></div></td><td><div id="_7"></div></td></tr>
				<tr><td><div id="_8"></div></td><td><div id="_10"></div></td><td><div id="_12"></div></td><td><div id="_14"></div></td><td><div class="c" id="_15"></div></td></tr>
			</table>
		</div>
		<svg height="16px" width="32px"><polygon points="0,16 16,0 32,16 16,10.7" stroke="#fff" fill="#fff8"></polygon></svg>
		<div id="cfg">
			<div class="rotdisp" id="sc_rot"><div><div id="sc_rotd"></div></div></div>
			<!--<svg width="64px" height="64px">
				<polygon points="9.5,13.5 9.5,50.5 39.5,50.5 39.5,13.5" stroke="#fea" stroke-width="3px" fill="#0000"></polygon>
				<polygon points="24.5,13.5 24.5,50.5 54.5,50.5 54.5,13.5" stroke="#fea" stroke-width="3px" fill="#0000"></polygon>
				<polygon points="20,15 20,36 29,36 29,15" fill="#fea"></polygon><polygon points="35,15 35,36 44,36 44,15" fill="#fea"></polygon>
				</svg>
			<svg width="64px" height="64px">
				<polygon points="12,24 28,8 52,8 52,56 12,56" stroke="#fea" stroke-width="2px" fill="#0000"></polygon><polygon points="12,24 28,8 28,24" fill="#fea"></polygon>
				<circle r="6" cx="32" cy="44" fill="#fea"/><polygon points="38,18 38,44 36,44 36,18" fill="#fea"></polygon>
			</svg>-->
			<br>
			<div style="font-size:11px;">
				powerd by <a href="https://github.com/Tonejs/Tone.js">Tone.js</a><br>
				<a href="https://github.com/Tonejs/Tone.js/tree/dev/examples/audio/salamander">default sound</a>(under cc3.0) author: Alexander Holm
			</div>
		</div>
		<script>
			var sc=0,scm=[];
			kb.style.opacity="0.2";kb.style.pointerEvents="none";
			const piano = new Tone.Sampler(
				{"A2":"A2.mp3","D#3":"Ds3.mp3","A3":"A3.mp3","D#4":"Ds4.mp3","A4":"A4.mp3","D#5":"Ds5.mp3","A5":"A5.mp3","D#6":"Ds6.mp3","A6":"A6.mp3","D#7":"Ds7.mp3"},
				()=>{kb.style.opacity="1";kb.style.pointerEvents="auto";},"https://tonejs.github.io/examples/audio/salamander/"
			).toDestination();

			function load() {
				var h = location.hash.slice(1);
				if(h){
					h = h.split(",");
					if(h[0])sc=parseInt(h[0]);
				}
			}
			load();
			const save = ()=>{location.hash=[sc].join();console.log("saved")},
			rotd = (s)=>{sc_rotd.style.transform="rotateZ("+sc*30+"deg)";if(s)save();};
			rotd(0);
			var key = document.querySelectorAll('table div');
			//https://tomari.org/main/java/oto.html
			for(var i=0; i<key.length; i++){
				key[i].addEventListener("touchstart",function(e){
					e.preventDefault();this.textContent="　";console.log(this.id);
					piano.triggerAttackRelease(440*Math.pow(2,(parseInt(this.id.slice(1))+sc)/12));
					this.classList.remove('on');void this.offsetWidth;this.classList.add('on_','on');
				},false);
				key[i].addEventListener("touchend",function(){this.classList.remove('on_');},false);
				key[i].addEventListener("touchcancel",function(){this.classList.remove('on_');},false);
				key[i].addEventListener("mousedown",function(){
					if(this.textContent=="　")this.textContent="";else{
						console.log(this.id);
						piano.triggerAttackRelease(440*Math.pow(2,(parseInt(this.id.slice(1))+sc)/12));
						this.classList.remove('on');void this.offsetWidth;this.classList.add('on_','on');
						setTimeout(()=>this.classList.remove('on_'),100);
					}
				},false);
				key[i].addEventListener("animationend",function(){this.classList.remove('on');},false);
			}
			sc_rot.children[0].ontouchstart = (e)=>{e.preventDefault;sc_rotd.textContent="　";scm=[true,sc,e.changedTouches[0].clientX,e.changedTouches[0].clientY];console.log("touch",scm);};
			sc_rot.children[0].ontouchmove = (e)=>{e.preventDefault;if(scm[0]){sc=scm[1]+Math.floor((e.changedTouches[0].clientX-scm[2])*.05+.5);rotd(0);}};
			sc_rot.children[0].ontouchend = (e)=>{if(scm[2]==e.changedTouches[0].clientX&&scm[3]==e.changedTouches[0].clientY)sc=0;rotd(1);scm[0]=false;console.log("touch_",sc);};
			sc_rot.children[0].onmousedown = (e)=>{if(sc_rotd.textContent=="　")sc_rotd.textContent="";else{scm=[true,sc,e.clientX,e.clientY];console.log("mouse",scm);}};
			window.onmousemove = (e)=>{if(scm[0]){sc=scm[1]+Math.floor((e.clientX-scm[2])*.05+.5);rotd(0);}};
			window.onmouseup = (e)=>{if(scm[0]){if(scm[2]==e.clientX&&scm[3]==e.clientY)sc=0;rotd(1);scm[0]=false;console.log("mouse_",sc);}};
		</script>
	</body>
</html>
