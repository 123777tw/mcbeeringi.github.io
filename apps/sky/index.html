<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>sky instruments</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<!--iOS-->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="default">
		<meta name="apple-mobile-web-app-title" content="sky instr">
		<link rel="apple-touch-icon" href="ico_512.png">
		<!--sw-->
		<link rel="manifest" href="sky_manifest.json">
		<script>
			if('serviceWorker' in navigator)navigator.serviceWorker.register('sky_sw.js').then((reg)=>{console.log('Service worker registered.', reg);});
		</script>
	</head>
	<body>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.5.45/Tone.js"></script>
		<style>
			:root{background:#222;background-repeat:no-repeat;user-select:none;-webkit-user-select:none;pointer-events:none;font-family:sans-serif;}
			html,body{height:100%;position:relative;margin:0;}
			#fixed{position:fixed;width:100%;height:100%;background:linear-gradient(#0008,#0000 64px),linear-gradient(#cce5f0,#ced980);}
			#kb{touch-action:none;margin:0 auto;}
			td{width:83px;height:83px;}
			td div{width:70px;height:70px;background-color:#aaa;border-radius:16px;box-shadow:0 0 10px #aaa;position:relative;cursor:pointer;margin:0 auto;z-index:0;}
			td div::before, td div::after{display:block;position:absolute;animation:bob 1.2s ease-in-out 0s infinite alternate;border:2px solid #fea;box-shadow:0 0 4px #fea8, 0 0 4px #fea8 inset;z-index:1;}
			td:nth-child(2n) div::before{content:"";top:18px;left:18px;width:30px;height:30px;}
			td:nth-child(2n-1) div::after{content:"";top:13px;left:13px;width:40px;height:40px;border-radius:50%;}
			td div.c::before, td div.c::after{content:"";top:15px;left:15px;width:36px;height:36px;}
			td div.on_{transform:scale(.8,.8);}td div:not(.on_){transition:.1s;}td div.on::before, td div.on::after{animation:on .4s ease-in-out;transform:rotateY(0deg)rotateZ(45deg);}
			svg{position:absolute;bottom:18px;left:50%;transform:translate(-50%);filter:drop-shadow(0 0 2px #0008);}
			#cfg{top:100%;width:100%;position:absolute;background:#444;}
			form{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;}
			input[type=radio]{display:none;}
			form div{width:64px;height:64px;margin:8px;border-radius:16px;background-color:#aaa;position:relative;overflow:hidden;}
			form div img{position:absolute;width:300%;}
			form input[type=radio]:checked+div{border:2px solid #fea;}
			@keyframes bob{
				0%{transform:rotateZ(45deg)scale(1,1);}
				100%{transform:rotateZ(45deg)scale(1.1,1.1);}
			}
			@keyframes on{
				0%{transform:rotateY(0deg)rotateZ(45deg);}
				100%{transform:rotateY(360deg)rotateZ(45deg);}
			}
		</style>


		<div id="fixed">
			<table id="kb">
				<tr><td><div class="c" id="_-9"></div></td><td><div id="_-7"></div></td><td><div id="_-5"></div></td><td><div id="_-4"></div></td><td><div id="_-2"></div></td></tr>
				<tr><td><div id="_0"></div></td><td><div id="_2"></div></td><td><div class="c" id="_3"></div></td><td><div id="_5"></div></td><td><div id="_7"></div></td></tr>
				<tr><td><div id="_8"></div></td><td><div id="_10"></div></td><td><div id="_12"></div></td><td><div id="_14"></div></td><td><div class="c" id="_15"></div></td></tr>
			</table>
		</div>
		<svg height="16px" width="32px"><polygon points="0,16 16,0 32,16 16,10.7" stroke="#fff" fill="#fff8"></polygon></svg>
		<div id="cfg">
			<form id="instr_" onchange="set();">
				<label><input type="radio" name="instr" value="0" checked><div><img src="instr.png" style="top:-64px;left:-64px;"></div></label>
				<label><input type="radio" name="instr" value="1"><div><img src="instr.png" style="top:-128px;left:-0px;"></div></label>
				<label><input type="radio" name="instr" value="2"><div><img src="instr.png" style="top:-128px;left:-64px;"></div></label>
				<label><input type="radio" name="instr" value="3"><div><img src="instr.png" style="top:-128px;left:-128px;"></div></label>
				<label><input type="radio" name="instr" value="4"><div><img src="instr.png" style="top:-192px;left:-128px;"></div></label>
				<label><input type="radio" name="instr" value="5"><div><img src="instr.png" style="top:-256px;left:-0px;"></div></label>
				<label><input type="radio" name="instr" value="6"><div><img src="instr.png" style="top:-256px;left:-64px;"></div></label>
				<label><input type="radio" name="instr" value="7"><div><img src="instr.png" style="top:-256px;left:-128px;"></div></label>
				<label><input type="radio" name="instr" value="8"><div><img src="instr.png" style="top:-320px;left:-0px;"></div></label>
				<label><input type="radio" name="instr" value="9"><div><img src="instr.png" style="top:-320px;left:-64px;"></div></label>
			</form>
		</div>
		<script>
			var sc=0;
			const instr_li = [//鍵盤番号+20
				{"c4":"Harp_0.mp3","a4":"Harp_5.mp3"},
				{"d5":"Contrabass_1.mp3","a5":"Contrabass_5.mp3"},
				{"c5":"Horn_0.mp3","c6":"Horn_7.mp3"},
				{"a4":"Piano_5.mp3","c5":"APPiano_0.mp3","c6":"APPiano_7.mp3"},
				{"c4":"Flute_0.mp3","c5":"Flute_7.mp3"},
				{"a5":"Quena_5.mp3"},
				{"a5":"Guitar_5.mp3"},
				{"a5":"Ukulele_5.mp3"},
				{"c4":"APPiano_0.mp3","c5":"APPiano_7.mp3"},
				{"c5":"Glock_0.mp3","c6":"Glock_7.mp3"}
			];
			if(location.hash)instr_.instr[parseInt(location.hash.slice(1))].checked=true;
			function set() {
				kb.style.opacity="0.2";kb.style.pointerEvents="none";
				instr_.querySelectorAll('label').forEach((e)=>{e.style.opacity="0.2";e.style.pointerEvents="none"});
				location.hash = instr_.instr.value;
				synth = new Tone.Sampler(instr_li[instr_.instr.value],()=>{
					kb.style.opacity="1";kb.style.pointerEvents="auto";
					instr_.querySelectorAll('label').forEach((e)=>{e.style.opacity="1";e.style.pointerEvents="auto"});
					console.log(JSON.stringify(instr_li[instr_.instr.value]));
				}).toDestination();
			}
			set();
			var key = document.querySelectorAll('table div');
			//https://tomari.org/main/java/oto.html
			for(var i=0; i<key.length; i++){
				key[i].addEventListener("touchstart",function(e){
					e.preventDefault();this.textContent="　";
					console.log(this.id);
					synth.triggerAttackRelease(440*Math.pow(2,(parseInt(this.id.slice(1))+sc)/12));
					this.classList.remove('on');
					void this.offsetWidth;//reflow
					this.classList.add('on_','on');
				},false);
				key[i].addEventListener("touchend",function(){this.classList.remove('on_');},false);
				key[i].addEventListener("touchcancel",function(){this.classList.remove('on_');},false);
				key[i].addEventListener("mousedown",function(){
					if(this.textContent=="　")this.textContent="";
					else{
						console.log(this.id);
						synth.triggerAttackRelease(440*Math.pow(2,(parseInt(this.id.slice(1))+sc)/12));
						this.classList.remove('on');
						void this.offsetWidth;//reflow
						this.classList.add('on_','on');
						setTimeout(()=>this.classList.remove('on_'),100);
					}
				},false);
				key[i].addEventListener("animationend",function(){this.classList.remove('on');},false);
			}
		</script>
	</body>
</html>
