<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-145066191-2"></script>
	<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-145066191-2');</script>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi minimap</title>
</head>
<body>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/atom-one-dark.min.css">
	<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js"></script>
	<style>
		:root{font-family:monospace;background:#222;color:#fff;tab-size:2;image-rendering:pixelated;}:link{color:#8cf;}
	</style>

	<h1>minimap</h1>
	<input type="file" id="inp"><br>
	<pre id="dl"></pre>
	<canvas id="c"></canvas>
	<pre><code id="out"></code></pre>
	<script>
		'use strict';
		const minimap=(e=document.documentElement,size=.5,c=document.createElement('canvas'))=>{
			e=e.cloneNode(true);document.body.appendChild(e);
			e.style.cssText+='position:fixed;top:0;left:0;visibility:hidden;';
			const ctx=c.getContext('2d'),
				pre=x=>x.childNodes.forEach(y=>{
					if(!y.tagName&&(y.textContent||'').trim()){
						const el=document.createElement('span');
						el.insertAdjacentHTML('beforeend',`<span>${y.textContent.replace(/</g,'>').replace(/([\n\r\s\t]+)/g,'</span>$1<span>')}</span>`.replace(/<span><\/span>/g,''));
						y.parentNode.replaceChild(el,y);
					}else pre(y);
				}),
				core=x=>{
					const b=x.getBoundingClientRect(),s=window.getComputedStyle(x),
						fill=()=>ctx.fillRect(...[b.x,b.y,b.width,b.height].map(y=>Math.round(y*size)));
					ctx.fillStyle=s.backgroundColor;fill();
					if(!x.children.length){ctx.fillStyle=s.color;fill();}
					else[...x.children].forEach(core);
				},
				b=e.getBoundingClientRect();
			c.width=b.width*size;c.height=b.height*size;
			pre(e);core(e);e.remove();
			return c;
		},
		main=x=>{
			out.textContent=x;
			hljs.highlightAll();
			minimap(out.parentNode,.5,c).toBlob(b=>{
				const a=document.createElement('a');
				a.download=`${inp.files[0].name}.${b.type.match(/\/\w+$/)[0].slice(1)}`a.textContent=`${a.download}\n`;
				a.href=URL.createObjectURL(b);a.onclick=()=>setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},5000);
				dl.appendChild(a);
			});
		};
		onload=()=>main(`console.log('Hello World!');`);
		inp.onchange=()=>{
			out.classList=(inp.files[0].name.match(/\.\w+$/)||[' plaintext'])[0].slice(1);
			inp.files[0].text().then(main);
		};
	</script>
</body>
</html>
