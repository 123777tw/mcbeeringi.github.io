<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-145066191-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-145066191-2');</script>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi dither</title>
	<meta name="description" content="mono dither">
	<link rel="shortcut icon" type="image/svg+xml" href="../img/icon.svg">
	<link rel="apple-touch-icon" href="../img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="../src/style.css">
</head>
<body>
	<style>#diffuse,textarea{width:100%;}#diffuse{max-width:512px;}</style>
	<h1>dither</h1>
	<hr>
	<input type="file" class="input" id="f"><br>
	lum&bg:<textarea class="input" id="il">//r,g,b, bg
[.298912,.586611,.114478, 0]</textarea><br>
	dither:<textarea class="input" id="im">[
	//x,y,weight
	/*
	//Floyd-Steinberg
	[ 1,0,7/16],
	[-1,1,3/16],[ 0,1,5/16],[ 1,1,1/16]
	*/
	//Atkinson
	[ 1,0,1/8],[ 2,0,1/8],
	[-1,1,1/8],[ 0,1,1/8],[ 1,1,1/8],
	[ 0,2,1/8]
]</textarea><br>
	<button type="button" class="button" id="b">exe</button><br>
	<img id="diffuse">
	<hr>
	<script src="https://cdn.jsdelivr.net/npm/autosize/dist/autosize.min.js"></script>
	<script>
		[il,im].forEach(x=>{autosize(x);x.oninput=()=>autosize.update(x);});
		const c=document.createElement('canvas'),
			ctx=c.getContext('2d'),
			main=(arr,w,m)=>{
				m=m.map(x=>[x[0]+x[1]*w,x[2],x[0]]);
				for(let i=0;i<arr.length;i++){
					const x=arr[i]>.5,e=arr[i]-x;
					m.forEach(([x,y,z])=>i+x<arr.length&&w-i%w>z&&(arr[i+x]+=e*y));
					arr[i]=x;
				}
				return arr;
			};
		b.onclick=()=>{
			let img=new Image();
			img.onload=()=>{
				const l=Function(`return(${il.value});`)();
				URL.revokeObjectURL(img.src);
				c.width=115/img.naturalHeight*img.naturalWidth;
				c.height=115;
				ctx.drawImage(img,0,0,c.width,c.height);
				img=ctx.getImageData(0,0,c.width,c.height);
				main(new Array(img.data.length/4).fill().map((_,i)=>{i*=4;return(img.data[i]*l[0]+img.data[i+1]*l[1]+img.data[i+2]*l[2])*img.data[i+3]/65025+l[3]*(1-img.data[i+3]/255);}),
					c.width,
					Function(`return(${im.value});`)()
				).forEach((x,i)=>{i*=4;img.data[i]=img.data[i+1]=img.data[i+2]=x*255;img.data[i+3]=255;});
				ctx.putImageData(img,0,0);
				c.toBlob(b=>{
					diffuse.onload=()=>URL.revokeObjectURL(diffuse.src);
					diffuse.src=URL.createObjectURL(b);
				})
			};
			img.src=URL.createObjectURL(f.files[0]);
		};
	</script>
</body>
</html>
