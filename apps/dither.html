<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-145066191-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-145066191-2');</script>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi dither</title>
	<meta name="description" content="mono dither">
	<link rel="shortcut icon" type="image/svg+xml" href="../img/icon.svg">
	<link rel="apple-touch-icon" href="../img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="../src/style.css">
	<link rel="stylesheet" href="../src/toggle.css">
</head>
<body>
	<style>#diffuse,textarea{width:100%;font-family:monospace;}#diffuse{max-width:1024px;}.ofs{overflow:scroll;}</style>
	<h1>dither</h1>
	<hr>
	<input type="file" class="input" id="f"><br>
	<br>
	<label>height:<input class="input" id="ih" value="256">px</label><br>
	rgba→mono:<textarea class="input" id="il">return(col[0]*.298912+col[1]*.586611+col[2]*.114478)*col[3]+0*(1-col[3]);</textarea><br>
	dither:<textarea class="input" id="im">[//→,↓,weight

	//Floyd-Steinberg
	//[ 1,0,7/16],[-1,1,3/16],[ 0,1,5/16],[ 1,1,1/16]

	//Atkinson
	[ 1,0,1/8],[ 2,0,1/8],[-1,1,1/8],[ 0,1,1/8],[ 1,1,1/8],[ 0,2,1/8]
]</textarea><br>
	<label>gap:<input class="input" id="ig" value="[1,1]"></label><br>
	<label>padding:<input type="checkbox" class="toggle" id="padcb" checked></label><br>
	<br>
	<button type="button" class="button" id="b">exe</button>
	<hr>
	<img id="diffuse">
	<div class="ofs"><pre id="out"></pre></div>
	<hr>
	<script src="https://cdn.jsdelivr.net/npm/autosize/dist/autosize.min.js"></script>
	<script>
		[il,im,out].forEach(x=>{autosize(x);x.oninput=()=>autosize.update(x);});
		ih.oninput=()=>ih.value=ih.value.replace(/\D+/g,'');
		const c=document.createElement('canvas'),
			ctx=c.getContext('2d'),
			dither=(arr,w,m)=>{
				m=m.map(x=>[x[0]+x[1]*w,x[2],x[0]]);
				for(let i=0;i<arr.length;i++){
					const e=arr[i]-(arr[i]=arr[i]>.5);
					m.forEach(([x,y,z])=>i+x<arr.length&&w-i%w>z&&(arr[i+x]+=e*y));
				}
				return arr;
			},
			braille=(arr,w,cfg={gap:[1,1],pad:1})=>{
				const h=arr.length/w;
				return new Array(Math.ceil((h+cfg.gap[1])/(4+cfg.gap[1]))).fill().map((_,i)=>
					new Array(Math.ceil((w+cfg.gap[0])/(2+cfg.gap[0]))).fill().map((_,j)=>{
						let s=[j*(2+cfg.gap[0]),i*(4+cfg.gap[1])];
						s=[7,4,6,3,5,2,1,0].reduce((a,x,k)=>{
							a[x]=+arr[s[0]+k%2+(s[1]+Math.floor(k/2))*w]||0;
							return a;
						},[]).join('');
						return String.fromCharCode(10240+(parseInt(s,2)||cfg.pad));
					}).join('')
				).join('\n');
			};
		b.onclick=()=>{
			let img=new Image();
			img.onload=()=>setTimeout(()=>{
				URL.revokeObjectURL(img.src);
				c.width=(ih.value/img.naturalHeight||1)*img.naturalWidth;
				c.height=+ih.value||img.naturalHeight;
				ctx.drawImage(img,0,0,c.width,c.height);
				img=ctx.getImageData(0,0,c.width,c.height);
				let mono=new Array(img.data.length/4).fill().map((_,i)=>{i*=4;return[...img.data.slice(i,i+4)].map(x=>x/255);}).map(Function('col',il.value));
				mono=dither(mono,c.width,Function(`return(${im.value});`)());
				mono.forEach((x,i)=>{i*=4;img.data[i]=img.data[i+1]=img.data[i+2]=x*255;img.data[i+3]=255;});
				ctx.putImageData(img,0,0);
				c.toBlob(b=>{diffuse.onload=()=>URL.revokeObjectURL(diffuse.src);diffuse.src=URL.createObjectURL(b);});
				b.disabled=false;
				out.textContent=braille(mono,c.width,{gap:Function(`return(${ig.value});`)(),pad:+padcb.checked});out.oninput();
			},0);
			img.onerror=()=>b.disabled=false;
			img.src=URL.createObjectURL(f.files[0]);
			b.disabled=true;
		};
	</script>
</body>
</html>
