<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<script async src="https://mcbeeringi.github.io/src/gas.js"></script>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi GitDir</title>
	<meta name="description" content="xor encrypter">
	<link rel="icon" type="image/svg+xml" href="../img/icon.svg">
	<link rel="apple-touch-icon" href="../img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="../src/style.css">
</head>
<body>
	<style>
		pre{display:inline-block;vertical-align:top;}
	</style>
	<h1>GitDir</h1>
	<hr>
	<input class="input" id="inp" placeholder="https://github.com/OWNER/REPO/TYPE/REF/PATH/" style="width:100%;">
	<button id="btn" class="button">download</button><br>
	<pre id="err"></pre><br>

	<script type="module">
		import{zip,dl,progress}from'https://mcbeeringi.github.io/petit/zip.mjs';

		btn.onclick=_=>(async()=>{
			let
				perc=x=>(x*100).toFixed(2)+' %',
				log=document.createElement('pre'),
				llog=(x,y)=>log.textContent=y?x+JSON.stringify(y,null,'	'):x,
				[,owner,repo,,ref='HEAD',...dir]=new URL(inp.value).pathname.split('/'),
				w=(llog('step 1/3: requesting repo info to api.github.com...\n',{}),await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${ref}?recursive=1`)),
				api_ratelimit={limit:w.headers.get('x-ratelimit-limit'),remaining:w.headers.get('x-ratelimit-remaining'),reset:new Date(w.headers.get('x-ratelimit-reset')*1000).toLocaleString()},
				core=async(x,d)=>(
					w.q.length&&(
						x=w.w[w.q.shift()],
						d={a:w.w.reduce((a,y)=>a+y.size,0)},
						(x.blob=await(progress(await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/${ref}/${dir}${x.path}`),y=>(x.loaded=y[0],
							llog('step 2/3: downloading assets...\n',{api_ratelimit,step_progress:perc(w.w.reduce((a,y)=>a+(y.loaded||0),0)/d.a),current:w.w.reduce((a,y)=>(y.loaded!=null&&!y.blob&&a.push(y),a),[])})
						))).blob()),
						await core()
					)
				);

			document.body.append(log);
			dir=decodeURIComponent(dir.join('/'));
			w=({r:w,w:(llog('step 1/3: requesting repo info to api.github.com...\n',{api_ratelimit}),await w.json())});
			if(w.w.tree){
				w=w.w.tree.reduce((a,x)=>(x.type=='blob'&&x.path.slice(0,dir.length)==dir&&(a.q.push(a.w.length),a.w.push({path:x.path.slice(dir.length),loaded:null,size:x.size,blob:null})),a),{...w,w:[],q:[]});console.log(w)
				if(w.w.length){
					await Promise.all([...Array(8)].map(core));
					console.log(w.w);
					dl({
						name:dir+'.zip',
						blob:await zip(w.w,{progress:x=>llog('step 3/3: gathering files...\n',{api_ratelimit,step_progress:perc((x.pre[0]/x.pre[1]+x.post[0]/x.post[1])/2),current:(w.w[x.post[0]]||{}).path,details:x})})
					});
					llog(dir+' done!');
				}else llog('No such file or directory.');
			}else llog(`${w.w.message} (${w.r.status} ${w.r.statusText})`);
			setTimeout(_=>log.remove(),3000);
		})().catch(e=>(err.textContent=e,console.log(e)));

		location.search&&(inp.value=location.search.slice(1),btn.onclick());
	</script>
</body>
</html>
