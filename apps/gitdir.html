<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<script async src="https://mcbeeringi.github.io/src/gas.js"></script>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi GitDir</title>
	<meta name="description" content="xor encrypter">
	<link rel="icon" type="image/svg+xml" href="../img/icon.svg">
	<link rel="apple-touch-icon" href="../img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="../src/style.css">
</head>
<body>
	<h1>GitDir</h1>
	<hr>
	<input class="input" id="inp" placeholder="https://github.com/OWNER/REPO/TYPE/REF/PATH" style="width:100%;">
	<button id="btn" class="button">run</button>
	<pre id="log">press run after input url.</pre>

	<script>
		const
			progress=(r,f)=>new Response(new ReadableStream({start:async(c,l=0,x,a=+r.headers.get('content-length'))=>{r=r.body.getReader();while((x=(await r.read()).value)&&!x.done){c.enqueue(x);f(l+=x.byteLength,a);}c.close();}})),
			llog=x=>log.textContent=x,
			zip=(w=[])=>((le32=(x,l=4)=>[...Array(l)].map((_,i)=>x>>(i<<3)&255),te=new TextEncoder())=>w.reduce(async(a,{path:n='dummy_'+Math.random().toString(16).slice(2),blob:b=new Blob(),date:d=new Date()},x)=>(
				a=await a,
				x={
					n:te.encode(n),b:new Uint8Array(await new Response(b).arrayBuffer()),
					d:le(((d.getFullYear()-1980)<<25)|((d.getMonth()+1)<<21)|(d.getDate()<<16)|(d.getHours()<<11)|(d.getMinutes()<<5)|(d.getSeconds()>>1))// mmmsssss hhhhhmmm MMMDDDDD YYYYYYYM // Y-=1980;s/=2;
				},
				x.c=[0,0,0,0],// TODO: CRC32 gen
				x.x=[10,0, 0,0, 0,0, ...x.d, ...x.c, ...(_=>[..._,..._])(le(x.b.byteLength)), ...le(x.n.byteLength,2), 0,0],// vReq flag cpsType date CRC32 cpsSize rawSize nameLength extLength
				a.cd.push(80,75,1,2, 10,0, ...x.x, 0,0, 0,0, 0,0, 0,0,0,0, ...le(a.fe.length), ...x.n),// PK0102 vMade X cmtLength 0304disk intAttr extAttr 0304pos name
				a.fe.push(80,75,3,4, ...x.x, ...x.n, ...x.b),// PK0304 X name content
				a
			),{fe:[],cd:[],_(){return new Blob([new Uint8Array([...this.fe,...this.cd,
				80,75,5,6, 0,0, 0,0, ...(_=>[..._,..._])(le(w.length,2)), ...le(this.cd.length), ...le(this.fe.length), 0,0// PK0506 disk 0304startDisk cnt0102disk cnt0102all 0102size 0102pos cmtLength
			],{type:'application/zip'}).buffer]);}})._())();

		btn.onclick=_=>(async()=>{
			let
				[,owner,repo,,ref,...dir]=new URL(inp.value).pathname.split('/'),
				w=await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${ref}?recursive=1`),
				core=async(x=w.w[w.q.shift()],stat,d)=>(
					(
						d={a:w.w.reduce((a,y)=>a+y.size,0),lim:{limit:w.r.headers.get('x-ratelimit-limit'),remaining:w.r.headers.get('x-ratelimit-remaining'),reset:new Date(w.r.headers.get('x-ratelimit-reset')*1000).toLocaleString()}},
						stat=_=>llog('step 2/3: downloading assets...\n'+JSON.stringify({api_ratelimit:d.lim,progress:(w.w.reduce((a,y)=>a+(y.loaded||0),0)*100/d.a).toFixed(2)+' %',files:w.w},null,'	'))
					)(x.blob=await(progress(await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/${ref}/${dir}${x.path}`),(l,a)=>stat(x.loaded=l))).blob()),
					w.q.length&&await core()
				);

			dir=decodeURIComponent(dir.join('/'));
			w=({r:w,w:(llog('step 1/3: requesting repo info to api.github.com...'),await w.json())});
			if(!w.w.tree)return llog(`${w.w.message} (${w.r.status} ${w.r.statusText})`);
			w=w.w.tree.reduce((a,x)=>(x.type=='blob'&&x.path.slice(0,dir.length)==dir&&(a.q.push(a.w.length),a.w.push({path:x.path.slice(dir.length),loaded:null,size:x.size,blob:null})),a),{...w,w:[],q:[]});
			await Promise.all([...Array(8)].map(core));
			llog('step 3/3: gathering files...');
			console.log(w);
		})().catch(llog);
	</script>
</body>
</html>
