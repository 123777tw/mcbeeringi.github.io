<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<script async src="https://mcbeeringi.github.io/src/gas.js"></script>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi GitDir</title>
	<meta name="description" content="xor encrypter">
	<link rel="icon" type="image/svg+xml" href="../img/icon.svg">
	<link rel="apple-touch-icon" href="../img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="../src/style.css">
</head>
<body>
	<style>
		pre{display:inline-block;vertical-align:top;}
	</style>
	<h1>GitDir</h1>
	<hr>
	<input class="input" id="inp" placeholder="https://github.com/OWNER/REPO/TYPE/REF/PATH" style="width:100%;">
	<button id="btn" class="button">download</button><br>
	<pre id="err"></pre><br>

	<script>
		const
			progress=(r,f)=>new Response(new ReadableStream({start:async(c,l=0,x,a=+r.headers.get('content-length'))=>{r=r.body.getReader();while((x=(await r.read()).value)&&!x.done){c.enqueue(x);f(l+=x.byteLength,a);}c.close();}})),
			perc=x=>(x*100).toFixed(2)+' %',
			// https://hgotoh.jp/wiki/doku.php/documents/other/other-017
			// https://gist.github.com/ysakasin/2edf8d3bf55c6ebf63f82851e302b030#relative-offset-of-local-header
			// https://ja.wikipedia.org/wiki/ZIP_(%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88)#%E6%8A%80%E8%A1%93%E7%9A%84%E3%81%AA%E6%83%85%E5%A0%B1
			zip=async(w=[],f)=>await(async(
				u=Uint8Array,zz=new u([0,0]),v10=new u([10,0]),pk=[...Array(3)].map((_,i)=>new u([80,75,(i*=2)+1,i+2])),stat={pre:[0,w.reduce((a,x)=>a+x.blob.size,0)],post:[0,w.length]},
				cnt=x=>x.reduce((a,y)=>a+(y.byteLength||y.size||0),0),le=(x,l=4)=>new u(l).map((_,i)=>x>>(i*8)),te=new TextEncoder(),
				crct=[...Array(256)].map((_,n)=>[...Array(8)].reduce((c,_,k)=>(c&1)?0xedb88320^(c>>>1):c>>>1,n)),crc=(buf,crc=0)=>buf.reduce((c,x)=>crct[(c^x)&0xff]^(c>>>8),crc^-1)^-1// https://www.rfc-editor.org/rfc/rfc1952
			)=>(f(stat),await w.reduce(async(a,{path:n='dummy_'+Math.random().toString(36).slice(2),blob:b=new Blob(),date:d=new Date()},x)=>(
				x={
					n:te.encode(n),c:le(crc(new u(await new Response(b).arrayBuffer()))),
					d:le(((d.getFullYear()-1980)<<25)|((d.getMonth()+1)<<21)|(d.getDate()<<16)|(d.getHours()<<11)|(d.getMinutes()<<5)|(d.getSeconds()>>1))// mmmsssss hhhhhmmm MMMDDDDD YYYYYYYM // Y-=1980;s/=2;
				},
				x.x=[v10,zz,zz,x.d,x.c,...(_=>[_,_])(le(b.size)),le(x.n.byteLength,2),zz],// vReq flag cpsType date CRC32 ...[cpsSize rawSize] nameLength extLength
				stat.pre[0]+=b.size,f(stat),a=await a,
				a.cd.push(pk[0],v10,...x.x,zz,zz,zz,zz,zz,le(cnt(a.fe)),x.n),// PK0102 vMade X cmtLength 0304disk intAttr extAttrLSB extAttrMSB 0304pos name
				a.fe.push(pk[1],...x.x,x.n,b),// PK0304 X name content
				stat.post[0]++,f(stat),a
			),{fe:[],cd:[],_(){return new Blob([...this.fe,...this.cd,
				pk[2],zz,zz,...(_=>[_,_])(le(w.length,2)),le(cnt(this.cd)),le(cnt(this.fe)),zz// PK0506 disk 0304startDisk ...[cnt0102disk cnt0102all] 0102size 0102pos cmtLength
			],{type:'application/zip'});}}))._())();

		btn.onclick=_=>(async()=>{
			let
				log=document.createElement('pre'),
				llog=(x,y)=>log.textContent=y?x+JSON.stringify(y,null,'	'):x,
				[,owner,repo,,ref,...dir]=new URL(inp.value).pathname.split('/'),
				w=await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${ref}?recursive=1`),
				api_ratelimit={limit:w.headers.get('x-ratelimit-limit'),remaining:w.headers.get('x-ratelimit-remaining'),reset:new Date(w.headers.get('x-ratelimit-reset')*1000).toLocaleString()},
				core=async(x,d)=>(
					w.q.length&&(
						x=w.w[w.q.shift()],
						d={a:w.w.reduce((a,y)=>a+y.size,0)},
						(x.blob=await(progress(await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/${ref}/${dir}${x.path}`),(l,a)=>(x.loaded=l,
							llog('step 2/3: downloading assets...\n',{api_ratelimit,step_progress:perc(w.w.reduce((a,y)=>a+(y.loaded||0),0)/d.a),current:w.w.reduce((a,y)=>(y.loaded!=null&&!y.blob&&a.push(y),a),[])})
						))).blob()),
						await core()
					)
				);

			document.body.append(log);
			dir=decodeURIComponent(dir.join('/'));
			w=({r:w,w:(llog('step 1/3: requesting repo info to api.github.com...\n',{api_ratelimit}),await w.json())});
			if(w.w.tree){
				w=w.w.tree.reduce((a,x)=>(x.type=='blob'&&x.path.slice(0,dir.length)==dir&&(a.q.push(a.w.length),a.w.push({path:x.path.slice(dir.length),loaded:null,size:x.size,blob:null})),a),{...w,w:[],q:[]});console.log(w)
				if(w.w.length){
					await Promise.all([...Array(8)].map(core));
					console.log(w.w);
					const a=Object.assign(document.createElement('a'),{download:dir+'.zip',href:URL.createObjectURL(await zip(w.w,x=>llog('step 3/3: gathering files...\n',{api_ratelimit,step_progress:perc((x.pre[0]/x.pre[1]+x.post[0]/x.post[1])/2),current:(w.w[x.post[0]]||{}).path,details:x})))});
					a.click();URL.revokeObjectURL(a.href);
					llog(dir+' done!');
				}else llog('No such file or directory.');
			}else llog(`${w.w.message} (${w.r.status} ${w.r.statusText})`);
			setTimeout(_=>log.remove(),3000);
		})().catch(e=>(err.textContent=e,console.log(e)));

		location.search&&(inp.value=location.search.slice(1),btn.onclick());
	</script>
</body>
</html>
