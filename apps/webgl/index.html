<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<title>McbeEringi WebGL</title>
	</head>
	<body>
		<script type="text/javascript" src="https://wgld.org/j/minMatrix.js">// https://wgld.org/d/webgl/w013.html</script>
		<script type="text/javascript" src="../../src/inflate.js">// https://www.onicos.com/staff/iz/amuse/javascript/expert/zip.html</script>
		<script type="text/javascript" src="../../src/deflate.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ace.js"></script>
		<script type="text/javascript" src="models.js"></script>
		<script type="text/javascript" src="index_fx.js"></script>
		<link rel="stylesheet" href="../../menu.css">
		<link rel="stylesheet" href="../../toggle.css">
		<style>
			:root{--menu_h:350px;--bg_col:#444c;}
			body{user-select:none;-webkit-user-select:none;background-color:rgba(32,32,32,1.0);color:#fff;margin:0;font-family:menlo,sans-serif;word-wrap:break-word;overflow-x:hidden;}
			body *{background-color:rgba(0,0,0,0);color:#fff;font-family:menlo,sans-serif;}
			.button{margin:7px;font-size:24px;width:45%;min-width:128px;text-align:center;}
				/*main.css*/
				.button{display:inline-block;vertical-align:bottom;outline:none;cursor:pointer;background:#aaa;color:#fff;border:none;border-bottom:4px solid #777;border-radius:4px;font-size:20px;}
				.button:hover{background:#48f;border-bottom-color:#888;}.button:active{background:#333;border-bottom:2px solid #0000;border-top:2px solid #0000;}
			canvas{width:100%;}
			p{font-size:11px;margin-left:7px;background-color:rgba(0,0,0,0);user-select:text;-webkit-user-select:text;}
			input{max-width:100%;}input[type=radio]{display:none;}
			input[type="radio"]+label{color:#888;}input[type="radio"]:hover+label{color:#aaa;}input[type="radio"]:checked+label{color:#fff;}
			.border{border:1px solid #888;border-radius:5px;}
			body>div:last-child *{color:#000;}
		</style>


		<canvas id="canvas">JavaScriptが無効になっているようです…</canvas><br>
		<div id="stuff">
			<div align="center">
				<form id="model" style="background-color:#444;" onchange="radio();">
					<span style="color:#fff;">model:</span>
					<input type="radio" name="model" value="0" id="r0" checked><label for="r0"> blocks</label>
					<input type="radio" name="model" value="1" id="r1"><label for="r1"> plane</label>
					<input type="radio" name="model" value="2" id="r2"><label for="r2"> tri</label>
				</form>
				<div class="button" onclick="compile();">compile</div>
			</div>
			<pre id="log" style="font-size:11px;color:#f00;"></pre>

			vertex <br>
			<div id="vsh" class="border">attribute highp vec4 POSITION;
attribute vec4 COLOR;
attribute vec2 TEXCOORD_1;
uniform mat4 WORLDVIEWPROJ;
varying vec4 color;
varying vec2 uv1;

void main(){
	color = COLOR;
	uv1 = TEXCOORD_1;
	gl_Position = WORLDVIEWPROJ * POSITION;
}</div><br>
			fragment <br>
			<div id="fsh" class="border">#extension GL_OES_standard_derivatives : enable
precision mediump float;

uniform sampler2D TEXTURE_1;
varying vec4 color;
varying vec2 uv1;

void main(){
	vec4 diffuse = color;
	diffuse *= texture2D(TEXTURE_1, uv1);
	gl_FragColor = diffuse;
}</div>
			<div style="display:flex;flex-wrap:wrap;">
				<div id="url" onclick="url_copy(document.getElementById('ifl').checked);" class="button" style="font-size:18px;">copy url</div>
				<span style="margin:auto 0 auto 15px;background-color:rgba(0,0,0,0);">iflame mode:</span>
				<input type="checkbox" class="toggle" id="ifl">
				<label for="ifl"><div></div></label>
			</div>
			<div>
				available stuffs<br>
				<p>
					#extension GL_OES_standard_derivatives : enable<br>
					attribute highp vec4 POSITION;<br>
					attribute highp vec4 COLOR;<br>
					attribute highp vec2 TEXCOORD_1;<br>
					uniform highp float TIME;<br>
					uniform highp vec4 FOG_COLOR;<br>
					uniform highp vec4 CURRENT_COLOR;<br>
					uniform highp mat4 WORLDVIEWPROJ;<br>
					uniform sampler2D TEXTURE_0;<br>
					uniform sampler2D TEXTURE_1;
				</p>
			</div>
			<div class="menu" style="margin-top:24px;margin-right:5px;">
				<input type="checkbox" id="menu">
				<label for="menu"></label>
				<div><div></div></div>
				<div>
					<h3>Config</h3>
					<div>
						<label>fps<br>
						<input type="number" id="fps" value="60" oninput="if(this.value!=0)fps=this.value;" class="border" style="width:4em;height:18px;"></label><br>
					</div><br>
					<div>
						<label>CURRENT_COLOR<br>
						<input type="text" id="c_c" value="1.0, 1.0, 1.0, 1.0" onchange="c_c=this.value.split(',')" class="border" style="width:100%;height:18px;"></label><br>
					</div><br>
					<div>
						<label>cam_rot<br>
						<input type="text" id="c_rot" value="0.5, 0.5*TIME, 0.0" onchange="c_rot=this.value" class="border" style="width:100%;height:18px;"></label><br>
					</div><br>
					<div>
						<label>cam_offset<br>
						<input type="text" id="c_os" value="0.0, 0.0, 5.0" onchange="c_os=this.value" class="border" style="width:100%;height:18px;"></label><br>
					</div><br>
					<p align="center" style="margin:0;font-size:11px;">
						powered by WebGL1.0 <br>
						special thanks to <a href="https://wgld.org" target="_blank">wgld.org</a> <br>
						display: 1600px * 900px <br>
						<a href="fsh.html">fsh sandbox</a><br>
						<a href="https://twitter.com/mcbeeringi" target="_blank">@McbeEringi</a>.｡:+*
					</p>
				</div>
			</div>
		</div>
		<script>
			var vsh = ace.edit("vsh",{
				//readOnly: true,
				showInvisibles: true,
				theme: "ace/theme/monokai",
				mode: "ace/mode/glsl",
				minLines: 16,
				maxLines: 32,
				fontSize: 12,
				wrap: true,
				useSoftTabs: false,
				tabSize: 2
			});
			var fsh = ace.edit("fsh",{
				//readOnly: true,
				showInvisibles: true,
				theme: "ace/theme/monokai",
				mode: "ace/mode/glsl",
				minLines: 16,
				maxLines: 32,
				fontSize: 12,
				wrap: true,
				useSoftTabs: false,
				tabSize: 2
			});
			url_i();
			var glpre = "#define round(x) floor(x+.5)\n";


			// https://wgld.org
			var c = document.getElementById("canvas");
			c.width = 1600;
			c.height = 900;
			var gl = c.getContext("webgl") || c.getContext("experimental-webgl");
			gl.enable(gl.CULL_FACE);
			gl.frontFace(gl.CCW);//gl.frontFace(gl.CW);
			gl.enable(gl.DEPTH_TEST);
			gl.depthFunc(gl.LEQUAL);
			gl.enable(gl.BLEND);
			gl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE);
			gl.getExtension("OES_standard_derivatives");

			compile();//シェダープログラム生成

			var POSITION = gl.getAttribLocation(prg, "POSITION");//attributeLocationの取得
			var COLOR = gl.getAttribLocation(prg, "COLOR");
			var TEXCOORD_1 = gl.getAttribLocation(prg, "TEXCOORD_1");

			var pos, col, index;
			var pos_v = gl.createBuffer();
			var col_v = gl.createBuffer();
			var uv1_v = gl.createBuffer();
			att([pos_v, col_v, uv1_v], [POSITION,COLOR,TEXCOORD_1], [4,4,2]);
			gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.createBuffer());//ibo
			radio();

			//minMatrixb.jsを用いた行列関連処理
			//各種行列の生成と初期化
			var m = new matIV();
			var WORLD = m.identity(m.create());
			var VIEW = m.identity(m.create());
			var PROJ = m.identity(m.create());
			var WORLDVIEWPROJ = m.identity(m.create());

			var FOG_COLOR = [.70,.82,.98,1.];
			var TIME = 0;
			var fps = document.getElementById("fps").value;
			var c_c = document.getElementById("c_c").value.split(",");
			var c_rot = document.getElementById("c_rot").value;
			var c_rot_;
			var c_os = document.getElementById("c_os").value;
			var c_os_;
			var texture = [];
			tex("tex/TEXTURE_0.png",0);
			tex("tex/TEXTURE_1.png",1);
			var prc;//二重起動防止
			function main(){
				clearTimeout(prc);
				TIME+=1/fps;
				clear(FOG_COLOR);

				c_os_ = eval("["+c_os+"]");
				m.lookAt([0,0,c_os_[2]], [c_os_[0],c_os_[1],0], [0,1,0], VIEW);//ビュー座標変換行列
				m.perspective(70, c.width / c.height, 0.1, 100, PROJ);//プロジェクション座標変換行列
				m.multiply(PROJ, VIEW, WORLDVIEWPROJ);
				m.identity(WORLD);
				c_rot_ = eval("["+c_rot+"]");
				m.rotate(WORLD, c_rot_[0], [1, 0, 0], WORLD);//ワールド座標変換行列
				m.rotate(WORLD, c_rot_[1], [0, 1, 0], WORLD);
				m.rotate(WORLD, c_rot_[2], [0, 0, 1], WORLD);
				m.multiply(WORLDVIEWPROJ, WORLD, WORLDVIEWPROJ);

				var uniform = [//uniformLocationの取得
					gl.getUniformLocation(prg, "WORLDVIEWPROJ"),
					gl.getUniformLocation(prg, "TIME"),
					gl.getUniformLocation(prg, "FOG_COLOR"),
					gl.getUniformLocation(prg, "CURRENT_COLOR"),
					gl.getUniformLocation(prg, "TEXTURE_0"),
					gl.getUniformLocation(prg, "TEXTURE_1")
				];
				gl.uniformMatrix4fv(uniform[0], false, WORLDVIEWPROJ);//uniformLocationにぶち込む
				gl.uniform1f(uniform[1], TIME);
				gl.uniform4fv(uniform[2], FOG_COLOR);
				gl.uniform4fv(uniform[3], c_c);

				gl.activeTexture(gl.TEXTURE0);
				gl.bindTexture(gl.TEXTURE_2D, texture[0]);
				gl.uniform1i(uniform[4], 0);
				gl.activeTexture(gl.TEXTURE1);
				gl.bindTexture(gl.TEXTURE_2D, texture[1]);
				gl.uniform1i(uniform[5], 1);

				gl.drawElements(gl.TRIANGLES, index.length, gl.UNSIGNED_SHORT, 0);//モデルの描画
				gl.flush();//コンテキスト再描画
				prc =setTimeout(main, 1000/fps);
			}
			main();
		</script>
	</body>
</html>
