<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-145066191-2"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-145066191-2');</script>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>McbeEringi fsh</title>
	</head>
	<body>
		<style>
			:root,input{background:#222;color:#fff;font-family:monospace;image-rendering:pixelated;user-select:none;-webkit-user-select:none;}
			:link,:visited{color:#fff;}.dn{display:none;}
			.usa,input{user-select:auto;-webkit-user-select:auto;}.cmt{opacity:.5;user-select:none;-webkit-user-select:none;}
			html,body{margin:0;height:100%;overflow:hidden;position:relative;}
			#prv,#fsh,.disp,.cfg{margin:0;width:100%;height:100%;position:absolute;object-fit:contain;}
			.disp{height:calc(100% - 128px);}.cfg{height:128px;margin;0;bottom:0;overflow:scroll;white-space:nowrap;scroll-snap-type:x mandatory;}
			#log{position:absolute;top:0;right:0;z-index:10;white-space:pre-wrap;font-size:10.5px;color:#f44;background:#2228;pointer-events:none;}
			#fsh{transition:.1s;}

			.cfg>*{display:inline-block;vertical-align:top;overflow:scroll;scroll-snap-align:start;height:100%;}
			.file{width:160px;height:120px;position:relative;overflow:hidden;text-shadow:0 0 4px #000;background-size:contain;background-repeat:no-repeat;background-position:center;background-color:#000;margin:2px 0;}
			.file input[type=file]{position:absolute;cursor:pointer;margin:0;width:100%;height:100%;opacity:0;}
			.file span{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);white-space:pre-wrap;pointer-events:none;}
			input{width:16ex;background-color:#0000;color:#fff;border:none;border-radius:0;border-bottom:2px solid #888;}input:focus{outline:none;background-color:#0002;border-bottom-color:#48f;transition:.2s;}
			.ace_editor{background:#2226;}.ace_marker-layer,.ace_gutter{opacity:.5;}

			.btn{display:inline-block;position:relative;margin:4px;padding:4px 8px;border-radius:4px;background:linear-gradient(#666,#444);text-decoration:none;}
			#ecb:checked~* #fsh{opacity:0;pointer-events:none;}#ecb:checked~* label[for="ecb"],.btn:active{background:#48f;}
			.btn>img{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;}
		</style>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-glsl.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.min.js"></script>
		<script src="https://mcbeeringi.github.io/src/webgl.js"></script>

		<input type="checkbox" id="ecb" class="dn">
		<input type="checkbox" id="ofcb" class="dn">
		<canvas id="c" class="dn"></canvas>
		<div class="disp">
			<canvas id="prv" style="pointer-events:none;"></canvas>
			<div id="fsh" class="usa">precision mediump float;
uniform float time;
uniform vec2 res;
void main(){
	vec2 p = gl_FragCoord.xy/res;
	gl_FragColor = vec4(p,sin(time)*.5+.5,1);
}</div>
			<pre id="log"></pre>
			<pre id="log_"></pre>
		</div>
		<div class="cfg">
			<div>
				<b>config</b><br>
				<label>size: <input id="isize" value="16,16" oninput="resize();save();"></label><br>
				<label>fps : <input id="ifps" type="number" value="30" oninput="save();"></label><br>
				<label for="ecb" class="btn">view mode</label><a class="btn" id="exp" ontouchstart="">export as url</a><br>
				<div class="btn">download png<img src id="diffuse"></div><a href id="dl" download></a>
			</div>
			<div class="usa">
				<b>uniforms</b><br>
				uniform float time;<br>
				<span class='cmt'>// <span id='tlog'>0.000</span> (<span id='flog'>0.0</span>fps)</span><br>
				uniform vec2 res;<br>
				<span class='cmt'>// defined in config>size</span><br>
				uniform sampler2D tex[0~3];<br>
				uniform vec2 tex[0~3]res;<br>
			</div>
			<div class="file"><input type="file" id="inp0" accept="image/*" onchange="read(this)">tex0<span></span></div>
			<div class="file"><input type="file" id="inp1" accept="image/*" onchange="read(this)">tex1<span></span></div>
			<div class="file"><input type="file" id="inp2" accept="image/*" onchange="read(this)">tex2<span></span></div>
			<div class="file"><input type="file" id="inp3" accept="image/*" onchange="read(this)">tex3<span></span></div>
			<div>
				powered by WebGL1.0<br>
				special thanks to <a href="https://wgld.org">wgld.org</a><br>
				build: 2102212<br>
				<a href="https://twitter.com/mcbeeringi">@McbeEringi</a>.ï½¡:+*<br>
				<div class="btn" onclick="location.href=location.href.replace('/fsh.html','/fsh_.html');">old UI</div>
			</div>
		</div>


		<script>
			'use strict';
			let gl=WebGL.setup(c,true,true),
				prvctx=prv.getContext('2d'),
				vsh='attribute vec2 UV;void main(){gl_Position=vec4(UV,0,1);}',
				prg=WebGL.compile(gl,vsh,'void main(){gl_FragColor=vec4(0);}'),
				fsh_e=ace.edit('fsh',{
					showInvisibles:true,
					theme:'ace/theme/monokai',
					mode:'ace/mode/glsl',
					fontSize:12,//wrap: true,
					useSoftTabs:false,tabSize:2
				}),
				mtim,texture=[],texres=[],t0=new Date(),t=[0,0,0],itim,curdat,tflag;
			fsh_e.on('input',()=>{clearTimeout(itim);itim=setTimeout(()=>{compile();save();},750);});

			prvctx.imageSmoothingEnabled=false;
			WebGL.attributes(gl,prg,[{name:'UV',data:[-1,-1,1,-1,-1,1,1,1],length:2}],[0,1,2,3,2,1]);

			const llog=x=>log.insertAdjacentHTML('beforeend',x),
			copy=x=>navigator.clipboard.writeText(x),
			resize=()=>{
				let s=isize.value.split(',',2);
				if(s[0]>0){c.width=s[0];prv.width=s[0];c.height=s[s[1]>0?1:0];prv.height=s[s[1]>0?1:0];}
				gl.viewport(0,0,gl.canvas.width,gl.canvas.height);
			},
			read=x=>{
				var url=URL.createObjectURL(x.files[0]);
				x.parentNode.style.backgroundImage=`url(${url})`;
				x=parseInt(x.id.slice(-1));
				WebGL.texture(gl,url,x=>{
					texture[i]=x;
					console.log(i+' loaded as tex',x);
					window['inp'+i].nextElementSibling.textContent=`uniform vec2 tex${i}res= vec2(${x.width},${x.height});`;
				});
			},
			compile=()=>{
				log.textContent='';
				try{prg=WebGL.compile(gl,vsh,fsh_e.getValue());}
				catch(e){log.textContent=WebGL.log;}
			},
			main=()=>{
				clearTimeout(mtim);
				mtim=setTimeout(main,1000/(Number(ifps.value)||60));
				t[0]=((new Date()-t0)*.001)%3600;
				if(t[0]-t[2]>.1){
					flog.textContent=(1/(t[0]-t[1])).toFixed(1);
					t[2]=t[0];tlog.textContent=t[0].toFixed(3);
				}
				t[1]=t[0];

				WebGL.uniforms(gl,prg,[
					{name:'time',type:'1f',data:t[0]},
					{name:'res',type:'2f',data:[c.width,c.height]},
					{name:'tex0',type:'tex',rname:'tex0res',data:texture[0]},
					{name:'tex1',type:'tex',rname:'tex1res',data:texture[1]},
					{name:'tex2',type:'tex',rname:'tex2res',data:texture[2]},
					{name:'tex3',type:'tex',rname:'tex3res',data:texture[3]},
				]);
				WebGL.draw(gl);
				prvctx.clearRect(0,0,prv.width,prv.height);
				prvctx.drawImage(c,0,0,prv.width,prv.height);
			},
			thumb=()=>{let tmp=[prv.width,prv.height];prv.width=32;prv.height=32;prvctx.drawImage(c,0,0,prv.width,prv.height);let s=prv.toDataURL();prv.width=tmp[0];prv.height=tmp[1];return s;},
			save=()=>{
				curdat={
					fsh:fsh_e.getValue(),
					size:isize.value.split(',',2)[1]?isize.value.split(',',2):Array(2).fill(isize.value.split(',',1)),
					fps:ifps.value,
					//thumb:thumb()
				};
				localStorage.fsh_curdat=JSON.stringify(curdat);
			},
			expbfx=()=>{save();exp.href=location.href.split('#')[0]+'#'+encodeURIComponent(JSON.stringify(curdat)).replace(/\(/g,"%28").replace(/\)/g,"%29");},
			difbfx=()=>dl.href=diffuse.src=c.toDataURL();
			exp.addEventListener('touchstart',()=>{tflag=true;expbfx();},{passive:true});
			exp.onmousedown=()=>{if(tflag)tflag=false;else expbfx();};
			exp.onclick=e=>{e.preventDefault();copy(exp.href).then(x=>{exp.textContent='copied';setTimeout(()=>exp.textContent='export as url',1000);});};
			diffuse.addEventListener('touchstart',()=>{tflag=true;difbfx();},{passive:true});
			diffuse.onmousedown=()=>{if(tflag)tflag=false;else difbfx();};
			diffuse.onclick=e=>{e.preventDefault();dl.click();}

			(()=>{
				let data=location.hash.slice(1);
				if(data)data=JSON.parse(decodeURIComponent(data.replace(/%28/g,"(").replace(/%29/g,")")));
				else if(localStorage.fsh_curdat)data=JSON.parse(localStorage.fsh_curdat);
				fsh_e.setValue(data.fsh,-1);
				if(data.size[0])isize.value=data.size.join(',');
				if(data.fps)ifps.value=data.fps;
			})();resize();compile();main();
			window.onbeforeunload=e=>{e.preventDefault();return'';};
			window.onresize=()=>fsh_e.resize();
		</script>
	</body>
</html>
