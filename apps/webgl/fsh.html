<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<title>McbeEringi fsh</title>
	</head>
	<body>
		<link rel="stylesheet" href="../../menu.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ace.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/zlibjs@0.3.1/bin/zlib.min.js"></script>
		<style>
			:root,input{
				--pos:fixed;--menu_h:320px;--bg_col:#888a;
				font-family:sans-serif;background-color:#222;color:#eee;image-rendering:pixelated;tab-size:2ex;user-select:none;-webkit-user-select:none;
			}
			_:lang(x)::-moz-placeholder,:root {image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;}
			.flex{display:flex;justify-content:space-around;flex-wrap:wrap;align-items:flex-start;}
			#diffuse{width:100%;max-width:640px;height:100%;object-fit:contain;}#log{width:100%;color:#f22;margin:0;word-wrap:break-word;}
			.box{width:300px;min-height:320px;height:50vh;flex-grow:1;display:block;border:1px solid #888;margin:2px;}
			.button{padding:4px 12px;background-color:#aaa;text-shadow:0 0 4px #0008;border-bottom:4px solid #888;border-radius:4px;}.button:hover{background-color:#48f;border-bottom-color:#aaa;}.button:active{background-color:#888;border-top:2px solid #0000;border-bottom:2px solid #0000;}
			input{background-color:#0000;color:#fff;border:none;border-radius:0;border-bottom:2px solid #888;font-size:16px;}input:focus{outline:none;background-color:#0002;border-bottom-color:#48f;transition:.2s;}
			.file{width:160px;height:120px;position:relative;border-radius:5px;border:1px solid #888;overflow:hidden;text-shadow:0 0 4px #000;background-size:contain;background-repeat:no-repeat;background-position:center;background-color:#000;margin:2px 0;}
			.file input[type=file]{position:absolute;cursor:pointer;margin:0;width:100%;height:100%;opacity:0;}
		</style>


		<canvas id="canvas" style="display:none;"></canvas>
		<div class="flex">
			<a id="dl" class="box" target="_blank" rel="noreferrer noopener">
				<img id="diffuse" alt="diffuse">
			</a>
			<div class="box" id="fsh">precision mediump float;
uniform float time;
uniform vec2 res;
void main(){
	vec2 p = gl_FragCoord.xy/res;
	gl_FragColor = vec4(p,sin(time)*.5+.5,1);
}</div>
		</div>
		<pre id="log"></pre>
		<div class="flex" style="max-width:800px;margin:0 auto;">
			<div class="file" id="inp0d"><input type="file" id="inp0" accept="image/*" onchange="read(this)">tex0</div>
			<div class="file" id="inp1d"><input type="file" id="inp1" accept="image/*" onchange="read(this)">tex1</div>
			<div class="file" id="inp2d"><input type="file" id="inp2" accept="image/*" onchange="read(this)">tex2</div>
			<div class="file" id="inp3d"><input type="file" id="inp3" accept="image/*" onchange="read(this)">tex3</div>
		</div>
		<div class="button" style="float:right;margin:1ex 0;" onclick="if(copy(location.href)){this.textContent='copied!';setTimeout(()=>this.textContent='copy url',1000);}">
			copy url
		</div>
		<h3>uniforms</h3>
		<p style="user-select:text;-webkit-user-select:text;">
			uniform float time;<br>
			uniform vec2 res;<br>
			uniform vec2 tex0res;<br>
			uniform vec2 tex1res;<br>
			uniform vec2 tex2res;<br>
			uniform vec2 tex3res;<br>
			uniform sampler2D tex0;<br>
			uniform sampler2D tex1;<br>
			uniform sampler2D tex2;<br>
			uniform sampler2D tex3;<br>
		</p>
		<div class="menu">
			<input type="checkbox" id="menu">
			<label for="menu"></label>
			<div><div></div></div>
			<div>
				<h3>Config</h3>
				<div>
					img size<br>
					<input type="number" id="w_" value="16" oninput="if(this.value>0){c.width=this.value;save();}else this.value=null" style="width:4em">
					*
					<input type="number" id="h_" value="16" oninput="if(this.value>0){c.height=this.value;save();}else this.value=null" style="width:4em">
				</div><br>
				<div>
					<label>fps<br>
					<input type="number" id="fps_" value="60" oninput="if(this.value>0){clearTimeout(prc);fps=this.value;save();main();}else this.value=null"></label>
				</div><br>
				<div>
					<label>compile wait(ms)<br>
					<input type="number" id="wait_" value="1000" oninput="if(this.value<0)this.value=0"></label>
				</div><br>
				<p align="center" style="margin:0;font-size:11px;">
					powered by WebGL1.0 <br>
					special thanks to <a href="https://wgld.org" target="_blank">wgld.org</a> <br>
					<a href="https://twitter.com/mcbeeringi" target="_blank">@McbeEringi</a>.｡:+*
				</p>
			</div>
		</div>
		<script>
		var fsh_e = ace.edit("fsh",{
			showInvisibles: true,
			theme: "ace/theme/monokai",
			mode: "ace/mode/glsl",
			fontSize: 12,
			wrap: true,
			useSoftTabs: false,
			tabSize: 2
		});
		fsh_e.on("input",()=>{clearTimeout(comp_timer);var comp_timer=setTimeout(compile,wait_.value,1);});
		var imgurl=[],imgres=[[0,0],[0,0],[0,0],[0,0]];
		function read(_this){
			var reader = new FileReader();
			var d = document.getElementById(_this.id+"d").style;
			var num = parseInt(_this.id.slice(-1));
			reader.addEventListener('load', ()=>{d.backgroundImage="url('"+reader.result+"')";imgurl[num]=reader.result;tex(num);}, false);
			reader.addEventListener('error',()=>{d.backgroundImage="linear-gradient(#f0f,#f0f)";log.innerText+="ERROR: "+_this.id+" loading failed"},false);
			reader.readAsDataURL(_this.files[0]);
			console.log(_this.id,imgurl,reader);
		}
		dl.onclick=()=>{
			dl.href="data:text/html,<a href='"+diffuse.src+"'download id='a'></a>"+
				unescape("%3Cscript%3Ea.click%28%29%3B%3C/script%3E");
		}

		function load() {
			var data = location.hash.slice(1);
			if(data){
				data=JSON.parse(decodeURIComponent(data.replace(/%28/g,"(").replace(/%29/g,")")));
				fsh_e.setValue(unescape(data.fsh),-1);
				if(data.size){w_.value = data.size[0];h_.value = data.size[1];}
				if(data.fps)fps_.value = data.fps;
			}
		}
		load();
		function save() {
			var data = {
				"fsh":fsh_e.getValue(),
				"size":[w_.value,h_.value],
				"fps":fps_.value
			}
			location.hash = encodeURIComponent(JSON.stringify(data)).replace(/\(/g,"%28").replace(/\)/g,"%29");
		}
		function copy(str){
			var tmp=document.createElement("div");
			var pre=document.createElement("pre");
			pre.style.webkitUserSelect="auto";pre.style.userSelect="auto";
			tmp.appendChild(pre).textContent = str;
			var s=tmp.style;s.position="fixed";s.right="200%";
			document.body.appendChild(tmp);
			document.getSelection().selectAllChildren(tmp);
			var result=document.execCommand("copy");
			document.body.removeChild(tmp);
			return result;
		}

		var c = document.getElementById("canvas");
		c.width = 4096;c.height = 4096;
		var gl = c.getContext("webgl") || c.getContext("experimental-webgl");
		c.width = w_.value;c.height = h_.value;
		gl.enable(gl.CULL_FACE);
		gl.frontFace(gl.CCW);//gl.frontFace(gl.CW);
		gl.enable(gl.DEPTH_TEST);
		gl.depthFunc(gl.LEQUAL);
		gl.enable(gl.BLEND);
		gl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE);
		gl.getExtension("OES_standard_derivatives");
		function create_shader(f){
			if(f){var shader = gl.createShader(gl.FRAGMENT_SHADER);var src = fsh_e.getValue();}
			else{var shader = gl.createShader(gl.VERTEX_SHADER); var src = "attribute vec2 UV;void main(){gl_Position=vec4(UV,0,1);}";}
			gl.shaderSource(shader, "#define round(x) floor(x+.5)\n"+src);
			gl.compileShader(shader);
			if(gl.getShaderParameter(shader, gl.COMPILE_STATUS))return shader;
			else log.innerText += gl.getShaderInfoLog(shader);
		}
		function create_program(vsh, fsh){
			var program = gl.createProgram();
			gl.attachShader(program, vsh);
			gl.attachShader(program, fsh);
			gl.linkProgram(program);
			log.innerText += gl.getProgramInfoLog(program);
			if(gl.getProgramParameter(program, gl.LINK_STATUS)){
				gl.useProgram(program);
				return program;
			}
		}
		function compile(s){
			log.innerText = "";
			prg = create_program(create_shader(0),create_shader(1));
			if(!log.innerText&&s)save();
		}
		compile(0);
		//attribute
		var UV = gl.getAttribLocation(prg, "UV");
		var uv_v = gl.createBuffer();
		gl.bindBuffer(gl.ARRAY_BUFFER, uv_v);
		gl.enableVertexAttribArray(UV);
		gl.vertexAttribPointer(UV, 2, gl.FLOAT, false, 0, 0);
		gl.bindBuffer(gl.ARRAY_BUFFER, null);
		gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.createBuffer());//ibo
			gl.bindBuffer(gl.ARRAY_BUFFER, uv_v);
			gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, 1,1]), gl.STATIC_DRAW);
			gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Int16Array([0,1,2, 3,2,1]), gl.STATIC_DRAW);
		//texture
		var texture = [];
		function tex(i){
			var img = new Image();
			img.onload = function() {
				var tex = gl.createTexture();
				gl.bindTexture(gl.TEXTURE_2D, tex);//バインドセット
				gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);//y反転
				gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);//読み込み
				gl.generateMipmap(gl.TEXTURE_2D);//生成
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);//拡大縮小
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);//端数処理
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
				gl.bindTexture(gl.TEXTURE_2D, null);//バインド解除
				imgres[i] = [img.naturalWidth,img.naturalHeight];
				texture[i] = tex;
				console.log("imgurl["+i+"] loaded as tex",imgres[i]);
			}
			img.src = imgurl[i];
		}
		var t = 0;
		var fps = fps_.value;
		var prc;//二重起動防止
		function main(){
			clearTimeout(prc);
			t+=1/fps;
			gl.clearColor(0,0,0,0);
			gl.clearDepth(1.);
			gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
			var uniform = [
				gl.getUniformLocation(prg, "time"),
				gl.getUniformLocation(prg, "res"),
				gl.getUniformLocation(prg, "tex0res"),
				gl.getUniformLocation(prg, "tex1res"),
				gl.getUniformLocation(prg, "tex2res"),
				gl.getUniformLocation(prg, "tex3res"),
				gl.getUniformLocation(prg, "tex0"),
				gl.getUniformLocation(prg, "tex1"),
				gl.getUniformLocation(prg, "tex2"),
				gl.getUniformLocation(prg, "tex3")
			];
			gl.uniform1f(uniform[0], t);
			gl.uniform2fv(uniform[1], [c.width,c.height]);
			gl.uniform2fv(uniform[2], imgres[0]);
			gl.uniform2fv(uniform[3], imgres[1]);
			gl.uniform2fv(uniform[4], imgres[2]);
			gl.uniform2fv(uniform[5], imgres[3]);

			gl.activeTexture(gl.TEXTURE0);
			gl.bindTexture(gl.TEXTURE_2D, texture[0]);
			gl.uniform1i(uniform[6], 0);
			gl.activeTexture(gl.TEXTURE1);
			gl.bindTexture(gl.TEXTURE_2D, texture[1]);
			gl.uniform1i(uniform[7], 1);
			gl.activeTexture(gl.TEXTURE2);
			gl.bindTexture(gl.TEXTURE_2D, texture[2]);
			gl.uniform1i(uniform[8], 2);
			gl.activeTexture(gl.TEXTURE3);
			gl.bindTexture(gl.TEXTURE_2D, texture[3]);
			gl.uniform1i(uniform[9], 3);

			gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);
			gl.flush();
			diffuse.src = c.toDataURL();

			prc =setTimeout(main, 1000/fps);
		}
		main();
		</script>
	</body>
</html>
