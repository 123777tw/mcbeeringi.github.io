<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<script async src="https://mcbeeringi.github.io/src/gas.js"></script>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi GitHubDir</title>
	<meta name="description" content="GitHub directory downloader">
	<link rel="icon" type="image/svg+xml" href="../img/icon.svg">
	<link rel="apple-touch-icon" href="../img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="../src/style.css">
</head>
<body>
	<h1>GitHub Directory Downloader</h1>
	<hr>
	<button id="pastebtn" class="zab bgca">DL from Clipboard URL</button>
	<hr>
	<input class="zab" id="inp" placeholder="GitHub URL...">
	<button id="runbtn" class="zab bgca">Download</button>
	<button id="copybtn" class="zab bgca">Copy Downloader URL</button>
	<div id="logw"></div><br>

	<script type="module">
		import{zip,dl,progress}from'https://mcbeeringi.github.io/petit/zip.mjs';

		inp.onchange=runbtn.onclick=async(
			w,
			log=document.createElement('pre'),llog=x=>log.textContent=JSON.stringify(x,0,'\t'),
			[,owner,repo,,ref='HEAD',...dir]=new URL(inp.value).pathname.split('/')
		)=>(
			logw.append(log),
			llog({status:'...'}),
			w=await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${ref}?recursive=1`),
			w={lim:{
				limit:w.headers.get('x-ratelimit-limit'),
				remaining:w.headers.get('x-ratelimit-remaining'),
				reset:Math.ceil((w.headers.get('x-ratelimit-reset')-Date.now()/1000)/60)+' min'
			},w},
			llog({status:'1/3 Getting repo info...',api_ratelimit:w.lim}),
			w.w=await w.w.json(),
			w.w.tree?(
				dir[dir.length-1]&&dir.push(''),dir=decodeURIComponent(dir.join('/')),
				w.w=w.w.tree.reduce((a,x)=>(
					x.type=='blob'&&x.path.slice(0,dir.length)==dir&&
					a.push({name:x.path.slice(dir.length),size:x.size}),a
				),[]).sort((a,b)=>b.size-a.size),
				w.w.length?(
					w.w=await w.w.reduce(async(a,x,i)=>(
						await a,
						await(progress(await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/${ref}/${dir}${x.name}`),y=>
							llog({status:'2/3 Downloading...',current,total,a:(y[0]/y[1]*100).toFixed(2)})
						)).blob(),
						a
					),{a,x:[0,w.w.reduce((a,x)=>a+x.size,0)]})
				):llog({error:'No such file or directory.',api_ratelimit:w.lim})

			):llog({error:`${w.w.message} (${w.r.status} ${w.r.statusText})`,api_ratelimit:w.lim}),







			0
		);

		location.search&&(inp.value=location.search.slice(1),btn.onclick());
	</script>
</body>
</html>
